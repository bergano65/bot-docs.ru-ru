---
title: ПО промежуточного слоя | Документация Майкрософт
description: Общие сведения о ПО промежуточного слоя и его использовании в пакете SDK бота.
keywords: ПО промежуточного слоя, конвейер ПО промежуточного слоя, короткий канал, использование ПО промежуточного слоя
author: ivorb
ms.author: kamrani
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.date: 05/23/2019
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 42082f90db8079e7bc0152b2947705a9c1f15115
ms.sourcegitcommit: a6d02ec4738e7fc90b7108934740e9077667f3c5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/04/2019
ms.locfileid: "70299458"
---
# <a name="middleware"></a>ПО промежуточного слоя

[!INCLUDE [applies-to-v4](../includes/applies-to.md)]

ПО промежуточного слоя — это просто класс, который находится между адаптером и логикой бота, добавленный в коллекцию промежуточного программного обеспечения адаптера во время инициализации. Пакет SDK позволяет писать собственное или добавлять созданное другими пользователями ПО промежуточного слоя. Любые входящие или исходящие действия вашего бота будут передаваться через ПО промежуточного слоя.

Адаптер обрабатывает и направляет входящие действия через конвейер ПО промежуточного слоя бота в логику бота, а затем обратно. Каждый поток действий входа и выхода бота, каждый компонент ПО промежуточного слоя может проверять или выполнять действие до и после запуска логики бота.

Прежде чем приступить к работе с ПО промежуточного слоя, важно понять суть [ботов в целом](~/v4sdk/bot-builder-basics.md) и [как они обрабатывают действия](~/v4sdk/bot-builder-basics.md#the-activity-processing-stack).

## <a name="uses-for-middleware"></a>Использование ПО промежуточного слоя
Часто возникает следующий вопрос: "В каких случаях для реализации действий лучше выбрать ПО промежуточного слоя вместо обычной логики бота?". ПО промежуточного слоя расширяет интерактивные возможности ведения диалога с пользователями как перед, так и после обработки каждой _реплики_. Кроме того, ПО промежуточного слоя позволяет сохранять и извлекать сведения, касающиеся диалога, а также при необходимости вызывать дополнительную логику обработки. Ниже описаны некоторые распространенные сценарии применения ПО промежуточного слоя.

### <a name="looking-at-or-acting-on-every-activity"></a>Просмотр каждого действия и его выполнение
Есть множество ситуаций, которые требуют от бота соответствующего поведения для всех действий или только для отдельных действий определенного типа. Например, нам необходимо зарегистрировать каждое действие сообщения, которое получает бот, или предоставить резервный ответ, если бот еще не создал реплику ответа. ПО промежуточного слоя — это отличное место для этого со способностью действовать как до, так и после выполнения остальной части логики бота.

### <a name="modifying-or-enhancing-the-turn-context"></a>Изменение или расширение контекста включения
Некоторые общения могут быть намного плодотворнее, если бот имеет больше информации, чем предусмотрено в этом действии. ПО промежуточного слоя в этом случае может просмотреть текущие сведения о состоянии беседы, запросить источник внешних данных и добавить это к объекту [контекста реплик](~/v4sdk/bot-builder-basics.md#defining-a-turn) перед передачей выполнения логике бота. 

В пакете SDK определено ПО промежуточного слоя для ведения журнала, которое позволяет записывать входящие и исходящие действия. Но вы можете определить собственное ПО промежуточного слоя.

## <a name="the-bot-middleware-pipeline"></a>Конвейер ПО промежуточного слоя бота
Адаптер вызывает ПО промежуточного слоя для каждого действия в том порядке, в котором оно было добавлено. Адаптер передает объект контекста для возвращения и _следующего_ делегата, а ПО промежуточного слоя вызывает делегат для передачи управления следующему промежуточному программному обеспечению в конвейере. ПО промежуточного слоя также имеет возможность выполнять действия после возвращения _следующего_ делегата до завершения метода. Можно представить, что каждый объект ПО промежуточного слоя имеет первую и последнюю возможность действовать в отношении объектов ПО промежуточного слоя, которые следуют за ним в конвейере.

Например:

- Обработчик 1-го объекта ПО промежуточного слоя выполняет код перед вызовом _следующего_.
  - Обработчик 2-го объекта ПО промежуточного слоя выполняет код перед вызовом _следующего_.
    - Обработчик бота выполняет и возвращает.
  - Обработчик 2-го объекта ПО промежуточного слоя выполняет любой оставшийся код перед возвращением.
- Обработчик 1-го объекта ПО промежуточного слоя выполняет любой оставшийся код перед возвращением.

Если ПО промежуточного слоя не вызывает следующий делегат, адаптер не вызывает ни одно из последующих ПО или обработчиков бота, а также сокращается конвейер.

После завершения работы конвейера ПО промежуточного слоя бота возвращение завершается и его контекст выходит за пределы области.

ПО промежуточного слоя или бот могут создавать ответы и регистрировать обработчики событий ответа, но учитывайте, что ответы обрабатываются в отдельных процессах.

## <a name="order-of-middleware"></a>Порядок выполнения ПО промежуточного слоя
Поскольку порядок добавления ПО промежуточного слоя определяет порядок, в котором оно обрабатывает действие, важно определить последовательность добавления ПО промежуточного слоя.

> [!NOTE]
> Это дает общий шаблон, который работает для большинства ботов, но имейте ввиду, что каждая часть ПО промежуточного слоя будет взаимодействовать с другими частями.

Первыми действиями в конвейере ПО промежуточного слоя должны быть те, которые берут на себя задачи самого низкого уровня, которые используются постоянно. Например, ведение журнала, обработка исключений и перевод. Их порядок зависит от потребностей. Скажем, вам нужно перевести входящее сообщение перед сохранением или же сообщение требуется сохранить до перевода (что может означать, что сохраненные сообщения не будут переведены).

Последним в конвейере ПО промежуточного слоя должен быть специальный бот ПО промежуточного слоя, который является программным обеспечением, реализующим выполнение обработки каждого сообщения, отправленного вашему боту. Если ПО промежуточного слоя использует информацию о состоянии или другую информацию, заданную в контексте бота, добавьте ее в конвейер программного обеспечения после того, как оно изменит состояние или контекст.

## <a name="short-circuiting"></a>Сокращение каналов
_Сокращение каналов_ — важный фактор работы ПО промежуточного слоя и обработчиков ответов. Если выполнение должно продолжаться через последующие слои, нужно, чтобы ПО промежуточного слоя (или обработчик ответов) передало данные выполнения, вызвав _следующий_ делегат.  Если следующий делегат не вызывается в рамках ПО промежуточного слоя (или обработчика ответов), соответствующий конвейер сокращает канал и последующие слои не выполняются. Это означает, что вся логика ботов и любое ПО промежуточного слоя, определенное далее в конвейере, пропускается. Есть небольшое различие между способами сокращения каналов для реплик в ПО промежуточного слоя и в обработчике ответов.

Когда промежуточное ПО сокращает канал реплики, обработчик реплик бота не вызывается, а весь код ПО промежуточного слоя, выполненный до этого момента в конвейере, продолжает выполняться до завершения. 

Пропуск вызова _следующего_ делегата в обработчике событий означает, что событие отменяется и значительно отличается от логики пропуска промежуточного программного обеспечения. Не обработав остальную часть события, адаптер никогда не отправит его.

> [!TIP]
> Если вы сокращаете канал события ответа, например `SendActivities`, убедитесь, что такое поведение действительно требуется. Иначе возникнут трудности с исправлением этой ошибки.

## <a name="response-event-handlers"></a>Обработчики событий ответа
В дополнение к логике приложения и ПО промежуточного слоя в контекстный объект могут быть добавлены обработчики ответов (иногда называемые обработчиками событий или обработчиками событий активности). Эти обработчики вызываются, когда связанный ответ происходит в текущем объекте контекста перед выполнением фактического ответа. Эти обработчики полезны, когда вы знаете, что хотите сделать до или после фактического события по каждому действию этого типа для остальной части текущего ответа.

> [!WARNING]
> Ни в коем случае не вызывайте метод ответа на действие из своего соответствующего обработчика событий ответа (например, вызвав из обработчика отправки действий метод отправки действия). Таким образом можно создать бесконечный цикл.

Как вы помните, каждое новое действие получает новый поток для выполнения. Когда создается поток для обработки действия, список обработчиков для этого действия копируется в этот новый поток. Если нет добавленных обработчиков, то после этой точки будет выполняться определенное действие.
Адаптер управляет обработчиками, зарегистрированными в объекте контекста, почти так же, как конвейером ПО промежуточного слоя. Обработчики вызываются в том порядке, в котором добавлены. При команде "Далее" делегат передает управление следующему зарегистрированному обработчику событий. Если обработчик не вызывает следующий делегат, последующие обработчики событий не вызываются, происходит сокращение канала для события и адаптер не отправляет ответ в канал.

## <a name="handling-state-in-middleware"></a>Обработка состояний в ПО промежуточного слоя

Обычно для сохранения состояния в конце обработчика шагов выполняется вызов, сохраняющий изменения. Вы видите схему, на которой выделен вызов.

![Проблемы состояния для ПО промежуточного слоя](media/bot-builder-dialog-state-problem.png)

Проблемой такого подхода является то, что любые обновления состояния из некоторых пользовательских реализаций ПО промежуточного слоя, полученные после завершения метода обработки шагов бота, не будут сохранены в долговременное хранилище. Чтобы решить эту проблему, переместите вызов для сохранения изменений так, чтобы он выполнялся после пользовательского ПО промежуточного слоя. Для этого добавьте экземпляр _auto-save changes_ в начало стека ПО промежуточного слоя или по меньшей мере до любых обращений к ПО промежуточного слоя, приводящих к изменению состояния. Такая реализация представлена в следующем примере.

![Решение проблемы состояния для ПО промежуточного слоя](media/bot-builder-dialog-state-solution.png)

Добавьте объекты управления состоянием, которым потребуется обновлять объект _набора состояний бота_, и примените их при создании ПО промежуточного слоя для автоматического сохранения изменений.


## <a name="additional-resources"></a>Дополнительные ресурсы
Ознакомьтесь с реализацией ПО промежуточного слоя для ведения журнала расшифровки в пакете SDK Bot Framework [[C#](https://github.com/Microsoft/botbuilder-dotnet/blob/master/libraries/Microsoft.Bot.Builder/TranscriptLoggerMiddleware.cs) | [JS](https://github.com/Microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/transcriptLogger.ts)].
