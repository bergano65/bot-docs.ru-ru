---
title: Обработка действий | Документация Майкрософт
description: Сведения об обработке действий в пакете SDK для ботов.
keywords: адаптер ботов, пользовательское ПО промежуточного слоя, укорачивание, резервирование, обработчики событий
author: jonathanfingold
ms.author: jonathanfingold
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.subservice: sdk
ms.date: 05/23/2019
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 69ce362f35054c5ee42035d8bffefb17c6fa7f71
ms.sourcegitcommit: ea64a56acfabc6a9c1576ebf9f17ac81e7e2a6b7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/24/2019
ms.locfileid: "66215506"
---
# <a name="activity-processing"></a>Обработка действий

[!INCLUDE[applies-to](../includes/applies-to.md)]

Боты и пользователи взаимодействуют и обмениваются данными с помощью действий. Каждое действие, получаемое приложением бота, передается адаптеру бота, который передает сведения о действиях в логику бота и в конечном счете отправляет ответы пользователю. Получение действия и последующая его обработка ботом называется репликовым шагом. Репликовый шаг представляет один полный цикл работы бота. Шаг завершается, когда выполнены все операции, действие полностью обработано и завершены все уровни бота.

Действия, особенно те, которые [отправляет бот](#generating-responses) в рамках репликового шага, обрабатываются асинхронно. Это необходимая часть построения бота. Если нужно разобраться, как это работает, изучите в зависимости от выбора языка [средства асинхронного программирования для .NET](https://docs.microsoft.com/en-us/dotnet/csharp/async) или [средства асинхронного программирования для JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function).

## <a name="the-bot-adapter"></a>Адаптер бота

Адаптер ботов инкапсулирует процессы проверки подлинности, а также отправляет и получает действия от службы Bot Connector. Когда бот получает действие, адаптер скрывает полные сведения о нем, создает [объект контекста](#turn-context), передает логику приложения бота и отправляет ответы, созданные ботом, обратно в почтовый ящик канала.

## <a name="authentication"></a>Аутентификация

Адаптер проверяет подлинность каждой входящей активности, получаемой приложением, используя информацию из действия и заголовок `Authentication` из запроса REST. Адаптер использует объект соединителя и учетные данные приложения для проверки подлинности исходящих действий для пользователя.

Проверка подлинности службы Bot Connector использует маркеры JWT (JSON Web Token) `Bearer`, **идентификатор приложения Microsoft** и **пароль приложения Microsoft**, которые Azure создает вместе со службой ботов или при регистрации бота. Приложение должно учитывать эти учетные данные во время инициализации, чтобы разрешить адаптеру проверить подлинность трафика.

> [!NOTE]
> Если управление или тестирование бота происходит локально, например с помощью Bot Framework Emulator, это можно сделать без настройки адаптера для проверки подлинности трафика к боту и от бота.

## <a name="turn-context"></a>Включение контекста

Когда адаптер получает действие, он создает объект с функцией **Включить контекст**, которая предоставляет информацию о поступающей активности, отправителе и получателе, канале, общении и другие данные, необходимые для обработки активности. Затем адаптер передает боту этот объект с контекстом. Объект контекста сохраняется на протяжении включения и предоставляет сведения о следующем.

* Общение. Идентификация общения, включая информацию о боте и пользователе, участвующем в общении.
* Действие. Запросы и ответы в общении имеют все типы действий. Этот контекст предоставляет сведения о входящих действиях, включая сведения о маршрутизации, канале, общении, отправителе и получателе.
* Пользовательские сведения. Если расширить бот либо путем реализации промежуточного слоя, либо в логике ботов, можно предоставить дополнительные сведения о каждом этапе.

Объект контекста также может использоваться для отправки ответа пользователю и получения ссылки на адаптер<!-- to create a new conversation or continue an existing one-->.

> [!NOTE]
> Приложение и адаптер будут обрабатывать запросы асинхронно. Однако для вашей бизнес-логики не требуется управление типа "запрос — ответ".

## <a name="middleware"></a>ПО промежуточного слоя

К адаптеру можно добавить ПО промежуточного слоя. ПО промежуточного слоя и логика бота используют объект контекста для получения информации о действиях и работают соответственно. ПО промежуточного слоя и бот могут также обновить или добавить сведения в объект контекста, например, для отслеживания состояния включения, общения и других областей. Дополнительные сведения о ПО промежуточного слоя см. [в этой статье](~/v4sdk/bot-builder-concept-middleware.md).

## <a name="generating-responses"></a>Создание ответов

Объект контекста предоставляет методы реагирования на действия, позволяющие коду реагировать на действие.

* Методы _отправки действия_ и _отправки действий_ отправляют одно или несколько действий в диалог.
* Если канал поддерживает метод действия _обновить действие_, он обновляет действие в общении.
* Если канал поддерживает метод действия _удалить действие_, он убирает действие из общения.

Каждый метод ответа выполняется в асинхронном процессе. При вызове этот метод клонирует связанный список [обработчиков событий](#response-event-handlers) перед обращением к ним. Это значит, что метод будет содержать все обработчики, добавленные до этой точки, но не будет содержать ничего, добавленного после запуска процесса.

Это также означает, что порядок ответов не гарантируется, особенно когда одна задача сложнее другой. Если бот может создать несколько ответов на входящее действие, убедитесь, что пользователь получил их в правильном порядке.

> [!IMPORTANT]
> Поток, обрабатывающий первое включение бота, связан с удалением объекта контекста после окончания работы. Если ответ (включая его обработчиков) занимает какое-то значительное время и пытается действовать на объект контекста, может произойти ошибка `Context was disposed`. **Обязательно ожидайте параметр `await` любых вызовов активности**, чтобы первичный поток дождался сгенерированного действия до завершения его работы и утилизации контекста включения.

## <a name="response-event-handlers"></a>Обработчики событий ответа

В дополнение к логике бота и ПО промежуточного слоя в контекстный объект могут быть добавлены обработчики ответов (иногда называемые обработчиками событий или обработчиками событий активности). Эти обработчики вызываются, когда связанный [ответ](#generating-responses) происходит в текущем объекте контекста перед выполнением фактического ответа. Эти обработчики полезны, когда вы знаете, что хотите сделать до или после фактического события по каждому действию этого типа для остальной части текущего ответа.

> [!WARNING]
> Будьте осторожны, чтобы не вызвать метод ответа активности из своего соответствующего обработчика событий ответа, например, вызвав из обработчика метод активности _отправка действия_. Таким образом можно создать бесконечный цикл.

Каждое новое действие получает новый поток для выполнения. Когда создается поток для обработки действия, список обработчиков для этого действия копируется в этот новый поток. Если нет добавленных обработчиков, то после этой точки будет выполняться определенное действие.

Адаптер управляет обработчиками, зарегистрированными в объекте контекста, почти так же, как [конвейером ПО промежуточного слоя](~/v4sdk/bot-builder-concept-middleware.md#the-bot-middleware-pipeline). А именно, обработчики вызываются в том порядке, в котором добавлены, и при команде _Далее_ делегат передает управление следующему зарегистрированному обработчику событий. Если обработчик не вызывает следующий делегат, последующие обработчики событий не вызываются, происходит [сокращение канала](~/v4sdk/bot-builder-concept-middleware.md#short-circuiting) для события и адаптер не отправляет ответ в канал.

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [ПО промежуточного слоя](~/v4sdk/bot-builder-concept-middleware.md)
