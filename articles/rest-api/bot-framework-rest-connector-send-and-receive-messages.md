---
title: Отправка и получение сообщений | Документация Майкрософт
description: Сведения об отправке и получении сообщений с помощью службы Bot Connector.
author: RobStand
ms.author: kamrani
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.subservice: sdk
ms.date: 12/13/2017
ms.openlocfilehash: 15ad5855fef9bc20f351e196941fe81822db5451
ms.sourcegitcommit: f3fda6791f48ab178721b72d4f4a77c373573e38
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/31/2019
ms.locfileid: "68671515"
---
# <a name="send-and-receive-messages"></a>Отправка и получение сообщений

Служба Bot Connector позволяет боту взаимодействовать через разные каналы связи, такие как Skype, электронная почта, Slack и т. д. Она обеспечивает обмен данными между ботом и пользователем, ретранслируя [действия](bot-framework-rest-connector-activities.md) между ботом и каналом в двустороннем порядке. Каждое действие содержит сведения, используемые для маршрутизации сообщения в соответствующее место назначения, а также сведения о создателе, контексте и получателе сообщения. В этой статье описывается, как использовать службу Bot Connector для обмена действиями **сообщений** между ботом и пользователем через канал. 

## <a id="create-reply"></a> Ответ на сообщение

### <a name="create-a-reply"></a>Создание ответа 

Когда пользователь отправляет боту сообщение, этот бот получает сообщение в виде объекта [Action][Activity] с типом **message**. Чтобы создать ответ на сообщение пользователя, создайте объект [Action][Activity] и задайте ему следующие свойства:

| Свойство | Значение |
|----|----|
| conversation | Присвойте этому свойству значение свойства `conversation` из сообщения пользователя. |
| from | Присвойте этому свойству значение свойства `recipient` из сообщения пользователя. |
| языковой стандарт | Присвойте этому свойству значение свойства `locale` из сообщения пользователя, если оно указано. |
| recipient | Присвойте этому свойству значение свойства `from` из сообщения пользователя. |
| replyToId | Присвойте этому свойству значение свойства `id` из сообщения пользователя. |
| Тип | Присвойте этому свойству значение **message**. |

Затем задайте свойства, которые определяют передаваемую пользователю информацию. Например, свойство `text` позволяет указать текст, отображаемый в сообщении, свойство `speak` — произносимый ботом текст, а свойство `attachments` — включаемые в сообщение вложения мультимедиа или расширенные карточки. Дополнительные сведения о часто используемых свойствах сообщения см. в руководстве по [созданию сообщений](bot-framework-rest-connector-create-messages.md).

### <a name="send-the-reply"></a>Отправка отчета

Используйте свойство `serviceUrl` во входящем действии, чтобы [определить базовый URI](bot-framework-rest-connector-api-reference.md#base-uri), который бот будет применять для отправки ответа. 

Чтобы отправить ответ, выполните такой запрос: 

```http
POST /v3/conversations/{conversationId}/activities/{activityId}
```

В URI этого запроса замените **{conversationId}** значением `id` из объекта `conversation` для действия (ответа), а также замените **{activityId}** значением свойства `replyToId` для действия (ответа). В текст запроса поместите объект [Action][Activity], созданный для представления ответа.

Следующий пример демонстрирует запрос, который отправляет простой текстовый ответ на сообщение пользователя. В этом примере запрос `https://smba.trafficmanager.net/apis` представляет базовый URI. Базовый URI для запросов, отправляемых вашим ботом, может отличаться. Дополнительные сведения о настройке базового URI см. в [справочнике по API](bot-framework-rest-connector-api-reference.md#base-uri).

```http
POST https://smba.trafficmanager.net/apis/v3/conversations/abcd1234/activities/5d5cdc723 
Authorization: Bearer ACCESS_TOKEN 
Content-Type: application/json 
```

```json
{
    "type": "message",
    "from": {
        "id": "12345678",
        "name": "Pepper's News Feed"
    },
    "conversation": {
        "id": "abcd1234",
        "name": "Convo1"
   },
   "recipient": {
        "id": "1234abcd",
        "name": "SteveW"
    },
    "text": "My bot's reply",
    "replyToId": "5d5cdc723"
}
```

## <a id="send-message"></a> Отправка сообщения (не ответа)

Как правило, бот отправляет сообщения только в ответ на сообщения пользователя. Но иногда боту нужно отправить в диалоге сообщение, не являющееся прямым ответом на сообщение пользователя. Например, бот может начать беседу на новую тему или попрощаться с пользователем в конце беседы. 

Чтобы отправить сообщение, не являющееся прямым ответом на сообщение пользователя, выполните такой запрос: 

```http
POST /v3/conversations/{conversationId}/activities
```

В URI запроса замените **{conversationId}** значением идентификатора беседы. 
    
В текст запроса поместите объект [Action][Activity], созданный для представления сообщения.

> [!NOTE]
> Bot Framework не накладывает каких-либо ограничений на число сообщений, которые может отправлять бот. Тем не менее большинство каналов принудительно применяет ограничения регулирования, запрещая ботам отправлять большое число сообщений за короткий период времени. Кроме того, если бот отправляет несколько сообщений за короткий промежуток времени, канал не всегда может обрабатывать сообщения в правильной последовательности.

## <a name="start-a-conversation"></a>Начало беседы

Возможны ситуации, когда боту требуется инициировать беседу с одним или несколькими пользователями. Чтобы начать беседу с пользователем по определенному каналу, бот должен иметь сведения о своей учетной записи и об учетной записи пользователя в соответствующем канале. 

> [!TIP]
> Если в будущем боту может потребоваться снова начать беседу с пользователями, сохраните в кэш данные о соответствующих учетных записях и другие важные сведения, например персональные настройки и языковой стандарт, а также URL-адрес службы (чтобы создать базовый URI для запроса на создание беседы). 

Чтобы начать беседу, выполните такой запрос: 

```http
POST /v3/conversations
```

В текст запроса поместите объект [ConversationParameters][], содержащий сведения об учетной записи бота и учетной записи пользователя или пользователей, которых нужно включить в беседу.

> [!NOTE]
> Не все каналы поддерживают групповые беседы. Изучите документацию по используемому каналу, чтобы узнать о поддержке групповых бесед и ограничениях на число участников в них.

В следующем примере показан запрос, который начинает беседу: В этом примере запрос `https://smba.trafficmanager.net/apis` представляет базовый URI. Базовый URI для запросов, отправляемых вашим ботом, может отличаться. Дополнительные сведения о настройке базового URI см. в [справочнике по API](bot-framework-rest-connector-api-reference.md#base-uri).

```http
POST https://smba.trafficmanager.net/apis/v3/conversations 
Authorization: Bearer ACCESS_TOKEN
Content-Type: application/json
```

```json
{
    "bot": {
        "id": "12345678",
        "name": "bot's name"
    },
    "isGroup": false,
    "members": [
        {
            "id": "1234abcd",
            "name": "recipient's name"
        }
    ],
    "topicName": "News Alert"
}
```

Если беседа с указанными пользователями создана, ответ будет содержать идентификатор этой беседы. 

```json
{
    "id": "abcd1234"
}
```

Теперь бот может использовать идентификатор беседы для [отправки сообщений](#send-message) пользователям в этой беседе.

## <a name="additional-resources"></a>Дополнительные ресурсы

- [Общие сведения о действиях](bot-framework-rest-connector-activities.md)
- [Создание сообщений](bot-framework-rest-connector-create-messages.md)

[Activity]: bot-framework-rest-connector-api-reference.md#activity-object
[ConversationAccount]: bot-framework-rest-connector-api-reference.md#conversationaccount-object
[ConversationParameters]: bot-framework-rest-connector-api-reference.md#conversationparameters-object

