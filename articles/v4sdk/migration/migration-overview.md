---
title: Общие сведения о переходе на новую версию пакета SDK Bot Framework — Служба Azure Bot
description: Обзор изменений в пакете SDK и способов перехода с версии 3 на версию 4.
keywords: Перенос бота
author: mmiele
ms.author: v-mimiel
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.date: 06/11/2019
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 0746a277f465979639db5c8a26aaddfee9386ac2
ms.sourcegitcommit: 772b9278d95e4b6dd4afccf4a9803f11a4b09e42
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2020
ms.locfileid: "80117696"
---
# <a name="migration-overview"></a>Общие сведения о переносе

Пакет SDK Bot Framework версии 4 разработан с учетом отзывов пользователей и опыта использования предыдущих версий пакета SDK. В новой версии реализованы требуемые уровни абстракции и обеспечена гибкая архитектура для компонентов бота. Это позволяет вначале создать простого бота, а затем усложнить его функциональность благодаря модульному подходу и расширяемости, реализованным в пакете SDK Bot Framework версии 4.

> [!NOTE]
> При создании пакета SDK Bot Framework версии 4 разработчики стремились обеспечить возможность реализации комплексных задач, не усложняя используемые подходы.

Открытый подход к разработке пакета SDK Bot Framework версии 4 позволил принять в ней активное участие членам сообщества. При первой подаче запроса на вытягивание происходит автоматическая оценка того, нужно ли вам подписать [лицензионное соглашение с участником](https://cla.opensource.microsoft.com/) (CLA). Это однократная процедура, позволяющая работать с разными репозиториями. Как правило, устанавливается определенный срок, чтобы обозначить задачи, которые планируется выполнить.

## <a name="what-happens-to-bots-built-using-sdk-v3"></a>Что будет с ботами, созданными с помощью пакета SDK версии 3

Пакет SDK Bot Framework версии 3 станет недоступным для работы, но существующие рабочие нагрузки ботов версии 3 продолжат работу. Дополнительные сведения см. в разделе: [Поддержка пакета SDK Bot Framework версии 3 на все время существования](https://docs.microsoft.com/azure/bot-service/bot-service-resources-bot-framework-faq?view=azure-bot-service-4.0#bot-framework-sdk-version-3-lifetime-support).

Настоятельно рекомендуем начать перенос ботов с версии 3 в версию 4. Чтобы упростить перенос, мы подготовили соответствующую документацию и окажем расширенную поддержку инициативам по переносу по стандартным каналам.

Если вы не можете выполнить миграцию бота из версии 3 в версию 4, вы все равно можете использовать дополнительные функции пакета SDK версии 4. Вы можете преобразовать бот версии 3 в навык и создать бот на основе пакета SDK версии 4, который будет выполнять роль потребителя навыков и передавать сообщения в бот версии 3. См. сведения о [преобразовании бота версии 3 в навык](convert-to-skill-overview.md).

## <a name="advantages"></a>Преимущества

- Более разнообразная, гибкая и открытая архитектура, позволяющая создавать сложные структуры диалога.
- "Доступность": добавлены сценарии с поддержкой новых каналов.
- Увеличен штат профильных специалистов, занятых в разработке. Новый конструктор с графическим пользовательским интерфейсом позволяет пользователям, которые не связаны с разработкой, участвовать в работе над структурами диалога.
- Повышение темпов разработки. Доступны новые средства разработчика для отладки и тестирования.
- Анализ производительности. Добавлены новые функции телеметрии для оценки и повышения качества диалога.
- Аналитика. Улучшены возможности Cognitive Services.

## <a name="why-migrate"></a>Аргументы в пользу миграции
<!-- [!] The declarative model introduced with Adaptive Dialogs would go great here (when ready).  -->
- Гибкое и оптимизированное управление диалогом.
  - Доступен адаптер бота для обработки действий.
  - Выполнен рефакторинг управления состоянием.
  - Добавлена новая библиотека диалогов.
  - Доступно ПО промежуточного слоя для составных и расширяемых структур. Доступны понятные и согласованные обработчики для настройки поведения.
- Поддержка .NET Core 2.
  - повышение производительности.
  - Кроссплатформенная поддержка (Windows, Mac, Linux).
- Единообразная программная модель для разных языков программирования.
- Улучшена документация.
- Bot Inspector обеспечивает расширенные возможности отладки.
- Виртуальный помощник
  - Комплексное решение, которое упрощает создание ботов, с такими компонентами и функциями, как основные намерения для реализации общения, интеграция со средством Dispatch, QnA Maker, Application Insights и автоматизированное развертывание.
  - Наращиваемые навыки. Возможность создавать решения для общения, комбинируя доступные для повторного использования возможности ведения беседы, называемые навыками.
- Платформа тестирования. Не требующие настройки возможности тестирования с новой архитектурой независимого транспортного адаптера.
- Телеметрия. Анализируйте сведения о работоспособности и поведении бота с помощью средств аналитики ИИ для общения.
- Ожидается (в предварительной версии).
  - Адаптивные диалоги. Позволяют разработчикам создавать диалоги, которые могут изменяться динамически в ходе беседы.
  - Создание языка. Позволяет определять несколько вариантов фразы.
- Планируется реализация.
  - Декларативный подход к разработке, задающий уровень абстракции для разработчиков.
  - Конструктор диалогов с графическим пользовательским интерфейсом.
- Служба Azure Bot 
  - Канал Direct Line Speech. Объединяет Bot Framework и службу "Речь" корпорации Майкрософт. Этот канал обеспечивает двустороннюю потоковую передачу речи и текста между клиентом и приложением бота.

## <a name="whats-changed"></a>Изменения

Пакет SDK Bot Framework версии 4 поддерживает ту же базовую службу Bot Framework, что и версия 3. Но в версии 4 выполнен рефакторинг кода предыдущей версии пакета SDK для повышения гибкости и уровня контроля над процессом создания ботов. Это включает следующие действия.

- Добавлен адаптера бота.
  - Адаптер — это компонент стека обработки действий.
  - Он выполняет аутентификацию Bot Framework и инициализирует контекст каждого шага.
  - Адаптер управляет входящим и исходящим трафиком между каналом и обработчиком шагов вашего бота, инкапсулируя вызовы службы Bot Framework Connector.
  - Дополнительные сведения см. в статье [Принципы работы бота](../bot-builder-basics.md).
- Выполнен рефакторинг управления состоянием.
  - Данные о состоянии больше не предоставляются в боте автоматически.
  - Управление состоянием теперь осуществляется через соответствующие объекты и методы доступа к свойствам.
  - Дополнительные сведения см. в статье [Управление состоянием](../bot-builder-concept-state.md).
- Добавлена новая библиотека диалогов.
  - Диалоги версии 3 необходимо переписать для новой библиотеки диалогов.
  - Дополнительные сведения см. в статье [Библиотека диалогов](../bot-builder-concept-dialog.md).

## <a name="whats-involved-in-migration-work"></a>Что необходимо выполнить при миграции

- Обновить логику настройки.
- Перенести критически важные данные о состоянии пользователя.
  - Примечание. Важные данные о состояние пользователя не следует хранить в службе "Состояние бота". Используйте для этого контролируемое вами отдельное хранилище.
- Перенести бота и логику диалога (дополнительные сведения см. в посвященных языку разделах).

### <a name="migration-estimation-worksheet"></a>Список задач в рамках миграции

Следующие списки задач помогут оценить объем рабочей нагрузки для миграции. В столбце **Количество** замените *значение* своими фактическими числовыми значениями. В столбце **Размер** укажите такие значения, как *Небольшой*, *Средний*, *Большой*, руководствуясь своей оценкой.

# <a name="c"></a>[C#](#tab/csharp)

| Шаг | V3 | Версия 4 | Вхождения | Сложность | Размер |
| -- | -- | -- | -- | -- | -- |
Получение входящего действия | IDialogContext.Activity | ITurnContext.Activity | count | Малый  
Создание действия и отправка его пользователю | activity.CreateReply("текст") IDialogContext.PostAsync | MessageFactory.Text("текст") ITurnContext.SendActivityAsync | count | Малый |
Управление данными о состоянии | UserData, ConversationData и PrivateConversationData context.UserData.SetValue context.UserData.TryGetValue botDataStore.LoadAsyn | UserState, ConversationState и PrivateConversationState с методами доступа к свойствам | context.UserData.SetValue "значение" context.UserData.TryGetValue "значение" botDataStore.LoadAsyn "значение" | Средняя–высокая (см. раздел[Управление данными о состоянии](https://docs.microsoft.com/azure/bot-service/bot-builder-concept-state?view=azure-bot-service-4.0#state-management)) |
Обработка запуска диалога | Реализация IDialog.StartAsync | Сделайте этот шаг первым в каскадном диалоге. | count | Малый |  
Отправка действия | IDialogContext.PostAsync. | Вызов ITurnContext.SendActivityAsync. | count | Малый |  
Ожидание ответа пользователя | Вызов IDialogContext.Wait с помощью параметра IAwaitable<IMessageActivity> | Возврат await ITurnContext.PromptAsync для начала диалога запроса. Затем получите результаты на следующем шаге каскадного диалога. | count | Средняя (в зависимости от потока) |  
Обработка продолжения диалога | IDialogContext.Wait | Добавление дополнительных шагов в каскадный диалог или реализация Dialog.ContinueDialogAsync | count | большой |  
Обозначение завершения обработки до следующего сообщения пользователя | IDialogContext.Wait | Возврат Dialog.EndOfTurn. | count | Средний |  
Запуск дочернего диалога | IDialogContext.Call | Возврат await BeginDialogAsyncmethod контекста шага. Если дочерний диалог вернет значение, оно будет доступно на следующем шаге каскадного диалога в свойстве Resultproperty. | count | Средний |  
Замена текущего диалога новым | IDialogContext.Forward | Возврат await ITurnContext.ReplaceDialogAsync. | count | большой |  
Информирование о завершении текущего диалога | IDialogContext.Done | Возврат await метода EndDialogAsync контекста шага. | count | Средний |  
Выход из диалога | IDialogContext.Fail | Создание исключения, которое будет зарегистрировано на другом уровне бота, и завершение шага с состоянием Cancelled, либо вызов шага или CancelAllDialogsAsync контекста диалога. | count | Малый |  

# <a name="javascript"></a>[JavaScript](#tab/javascript)

| Шаг | V3 | Версия 4 | Вхождения | Сложность | Размер |
| -- | -- | -- | -- | -- | -- |
Получение входящего действия | IMessage | TurnContext.activity | count | Малый  
Создание действия и отправка его пользователю | Вызов Session.send('message') | Вызов TurnContext.sendActivity | count | Малый |
Управление данными о состоянии | UserState и ConversationState UserState.get(), UserState.saveChanges(), ConversationState.get(), ConversationState.saveChanges() | UserState и ConversationState с методами доступа к свойствам | count | Средняя–высокая (см. раздел[Управление данными о состоянии](https://docs.microsoft.com/azure/bot-service/bot-builder-concept-state?view=azure-bot-service-4.0#state-management)) |
Обработка запуска диалога | Вызов session.beginDialog, передача идентификатора диалога | Вызов DialogContext.beginDialog | count | Малый |  
Отправка действия | Вызов Session.send | Вызов TurnContext.sendActivity | count | Малый |  
Ожидание ответа пользователя | Вызов запроса из каскадного шага, например builder.Prompts.text(сеанс, 'Please enter your destination'). Получите ответ на следующем шаге. | Возврат ожидания TurnContext.prompt для запуска диалога запроса. Затем получите результаты на следующем шаге каскадного диалога. | count | Средняя (в зависимости от потока) |  
Обработка продолжения диалога | Автоматически | Добавление дополнительных шагов в каскадный диалог или реализация Dialog.continueDialog | count | большой |  
Обозначение завершения обработки до следующего сообщения пользователя | Session.endDialog | Возврат Dialog.EndOfTurn | count | Средний |  
Запуск дочернего диалога | Session.beginDialog | Возврат ожидания метода beginDialog для контекста шага. Если дочерний диалог вернет значение, оно будет доступно на следующем шаге каскадного диалога в свойстве Result. | count | Средний |  
Замена текущего диалога новым | Session.replaceDialog | ITurnContext.replaceDialog | count | большой |  
Информирование о завершении текущего диалога | Session.endDialog | Возврат ожидания метода endDialog для контекста шага. | count | Средний |  
Выход из диалога | Session.pruneDialogStack | Создание исключения, которое будет зарегистрировано на другом уровне бота, и завершение шага с состоянием Cancelled, либо вызов шага или cancelAllDialogs контекста диалога. | count | Малый |  

---

# <a name="c"></a>[C#](#tab/csharp)

Пакет SDK Bot Framework версии 4 использует тот же базовый REST API, что и пакет SDK версии 3. Но в версии 4 выполнен рефакторинг кода предыдущей версии пакета SDK для повышения гибкости и улучшения контроля над ботами.

Мы рекомендуем перейти на .NET Core, что позволяет существенно повысить производительность. Но некоторые боты версии 3 используют внешние библиотеки, у которых нет аналогов на .NET Core. В таком случае пакет SDK Bot Framework версии 4 можно использовать с .NET Framework 4.6.1 или более поздней версии. Пример доступен в [этом репозитории](https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/csharp_webapi).

При переносе проекта из версии 3 в версию 4 можно выбрать один из следующих вариантов: преобразование в **.NET Framework** или перенос нового проекта на **.NET Core**.

#### <a name="net-framework"></a>.NET Framework

- Обновление и установка пакетов NuGet
- Обновление файла global.asax.cs
- Обновление класса MessagesController.
- Преобразование диалогов.

Дополнительные сведения см. статье [Перенос бота .NET версии 3 в бот .NET Framework версии 4](conversion-framework.md).

#### <a name="net-core"></a>.NET Core

- Создание проекта на основе шаблона
- Установите дополнительные пакеты NuGet при необходимости.
- Настройте бота согласно требованиям, обновите файла Startup.cs и класс контроллера.
- Обновление класса бота
- Скопируйте и обновите диалоги и модели.

Дополнительные сведения см. статье [Перенос бота .NET версии 3 в бот .NET Framework версии 4](conversion-core.md).

# <a name="javascript"></a>[JavaScript](#tab/javascript)

В пакете **SDK Bot Framework для Javascript версии 4** реализовано несколько важных изменений, связанных с процессом создания ботов. Эти изменения влияют на синтаксис для разработки ботов на Javascript. В особенности это касается создания объектов бота, определения диалогов и создания логики обработки событий. Пакет SDK Bot Framework версии 4 использует тот же базовый REST API, что и пакет SDK версии 3. Но в версии 4 выполнен рефакторинг кода предыдущей версии пакета SDK для повышения гибкости и улучшения контроля над ботами, в частности:

- Экземпляры диалогов и бота разграничены в большей степени. В версии 3 диалоги регистрировались непосредственно в конструкторе бота. В версии 4 диалоги передаются в экземпляры бота как аргументы, делая процесс создания более гибким.
- В версии 4 реализован класс `ActivityHandler` для автоматизации обработки разных типов действий, таких как сообщение, обновление беседы и событие.
- Для переноса бота Node.js необходимо создать нового бота Node.js версии 4 на JavaScript или TypeScript. Создайте заново логику бота с помощью новых конструкций версии 4, описанных в соответствующей документации по миграции.

#### <a name="migrate-from-v3-to-v4"></a>Перенос из версии 3 в версию 4

- Создайте проект и добавьте зависимости.
- Обновите точки входа и определите константы.
- Создайте диалоги и выполните их и повторную реализацию с помощью пакета SDK версии 4.
- Обновите код бота для вызова диалогов.
- Перенесите файл `store.js` служебной программы.

Дополнительные сведения см. в статье [Перенос бота на основе пакета SDK для JavaScript версии 3 в версию 4](conversion-javascript.md).

---

## <a name="additional-resources"></a>Дополнительные ресурсы

Перечисленные ниже ресурсы содержат дополнительные сведения, которые помогут с миграцией.  

### <a name="c"></a>[C#](#tab/csharp)

<!-- _Mini-TOC with explainer for .NET topics_ -->
В следующих разделах описаны различия между пакетами SDK Bot Framework для .NET версий 3 и 4, критические изменения в обеих версиях, а также приведены пошаговые инструкции по переходу с версии 3 на версию 4.

| Раздел | Описание |
| :--- | :--- |
| [Различия между версиями 3 и 4 пакета SDK для .NET](migration-about.md) |Различия между версиями 3 и 4 пакета SDK |
| [Краткий справочник по миграции для .NET](net-migration-quickreference.md) |Критические изменения в версиях 3 и 4 пакета SDK |
| [Перенос бота .NET версии 3 в .NET Framework версии 4](conversion-framework.md) |Перенос бота из версии 3 в версию 4 с использованием одного и того же типа проекта |
| [Перенос бота .NET версии 3 в бот .NET Core версии 4](conversion-core.md) | Перенос бота из версии 3 в версию 4 с помощью нового проекта .NET Core|

### <a name="javascript"></a>[JavaScript](#tab/javascript)

<!-- _Mini-TOC with explainer for JavaScript topics_ -->
В следующих разделах описаны различия в пакетах SDK Bot Framework для JavaScript версий 3 и 4, критические изменения в обеих версиях, а также приведены пошаговые инструкции по переходу с версии 3 на версию 4.

| Раздел | Описание |
| :--- | :--- |
| [Различия между версиями 3 и 4 пакета SDK для JavaScript](migration-about-javascript.md) | Различия между версиями 3 и 4 пакета SDK |
| [Краткий справочник по миграции для JavaScript](javascript-migration-quickreference.md)| Критические изменения в версиях 3 и 4 пакета SDK|
| [Перенос бота JavaScript версии 3 в версию 4](conversion-javascript.md) |Перенос бота из версии 3 в версию 4 |

---

### <a name="code-samples"></a>Примеры кода

Ниже приведены примеры кода, которые позволяют ознакомиться с пакетом SDK Bot Framework версии 4 или приступить к новому проекту.

| Примеры | Описание |
| :--- | :--- |
| [Примеры переноса бота из пакета SDK Bot Framework версии 3 в версию 4](https://github.com/microsoft/BotBuilder-Samples/tree/master/MigrationV3V4) <img width="200">| Примеры миграции из пакета SDK Bot Framework версии 3 в версию 4 |
| [Примеры Bot Builder для .NET](https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/csharp_dotnetcore) | Примеры Bot Builder для C# и .NET Core |
| [Примеры Bot Builder для JavaScript](https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/javascript_nodejs) | Примеры Bot Builder для JavaScript (Node.js) |
| [Все примеры Bot Builder](https://github.com/microsoft/BotBuilder-Samples/tree/master/samples) | Все примеры Bot Builder |

### <a name="getting-help"></a>Получение справки

Указанные ниже ресурсы содержат дополнительные сведения и могут помочь с разработкой ботов.

[Дополнительные ресурсы по Bot Framework](https://docs.microsoft.com/azure/bot-service/bot-service-resources-links-help?view=azure-bot-service-4.0)

### <a name="references"></a>Ссылки

Указанные ниже ресурсы содержат дополнительные и справочные сведения.

| Раздел | Описание |
| :--- | :--- |
| [Новые возможности Bot Framework](https://docs.microsoft.com/azure/bot-service/what-is-new?view=azure-bot-service-4.0) | Основные возможности и усовершенствования Bot Framework и Azure Bot|
|[Принципы работы бота](../bot-builder-basics.md)|Внутренний механизм бота|
|[Управление состоянием](../bot-builder-concept-state.md)|Абстракции, упрощающие управление состоянием|
|[Библиотека диалогов](../bot-builder-concept-dialog.md)| Основные концепции управления диалогом|
|[Отправка и получение текстовых сообщений](../bot-builder-howto-send-messages.md)|Основной способ взаимодействия бота с пользователями|
|[Отправка мультимедиа](../bot-builder-howto-add-media-attachments.md)|Отправка во вложении мультимедийных материалов, таких как изображения, файлы, видео и аудиозаписи| 
|[Реализация процесса общения](../bot-builder-dialog-manage-conversation-flow.md)| Постановка вопросов как основной способ взаимодействия бота с пользователями|
|[Сохранение данных пользователя и диалога](../bot-builder-howto-v4-state.md)|Отслеживание диалога без отслеживания состояния|
|[Сложный поток беседы](../bot-builder-dialog-manage-complex-conversation-flow.md)|Управление сложным процессом общения |
|[Повторное использование диалогов](../bot-builder-compositcontrol.md)|Создание независимых диалогов для особых сценариев|
|[Обработка прерываний](../bot-builder-howto-handle-user-interrupt.md)| Обработка прерываний для повышения эффективности бота|
|[Схема действий](https://aka.ms/botSpecs-activitySchema)|Схема действий, предпринимаемых в ходе беседы людьми и автоматическим программным обеспечением|
