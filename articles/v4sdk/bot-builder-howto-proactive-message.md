---
title: Отправка упреждающих уведомлений пользователям | Документация Майкрософт
description: Узнайте, как отправлять уведомления
keywords: proactive message, notification message, bot notification,
author: jonathanfingold
ms.author: kamrani
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.date: 05/23/2019
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 0c5268a16f7dcff8e46d3a14f32409517eb98489
ms.sourcegitcommit: 6a83b2c8ab2902121e8ee9531a7aa2d85b827396
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/09/2019
ms.locfileid: "68970712"
---
# <a name="send-proactive-notifications-to-users"></a>Отправка упреждающих уведомлений пользователям

[!INCLUDE[applies-to](../includes/applies-to.md)]

Как правило, каждое сообщение, которое бот отправляет пользователю, напрямую связано с данными, введенными пользователем ранее.
Иногда боту может потребоваться отправить пользователю сообщение, которое не имеет прямого отношения к текущей теме диалога или последнему сообщению пользователя. Такие сообщения называются _упреждающими_.

Упреждающие сообщения можно использовать в различных сценариях. Например, если пользователь ранее попросил бот отслеживать стоимость продукта, то бот может оповестить пользователя в случае, если стоимость продукта опустилась на 20 %. Если боту требуется какое-то время, чтобы сформировать ответ на вопрос пользователя, он может проинформировать пользователя о задержке и продолжить диалог. Когда бот сформирует ответ на вопрос, он передаст его пользователю.

Если вы реализуете в боте упреждающие сообщения, не отправляйте несколько таких сообщений за короткий промежуток времени. Некоторые каналы ограничивают частоту, с которой бот может отправлять сообщения пользователю, и отключают бот, если он нарушает эти ограничения.

Динамическое упреждающее сообщение — это самый простой тип упреждающих сообщений. Бот просто вставляет сообщение в диалог каждый раз, когда он активируется (вне зависимости от участия пользователя в отдельном разделе диалога с ботом в данный момент), и не пытается изменить диалог каким-либо способом.

Чтобы улучшить обработку уведомлений, рассмотрите другие варианты их интеграции в поток общения, например указав флаг в состоянии диалога или добавив уведомление в очередь.

## <a name="prerequisites"></a>Предварительные требования

- Понимание [основных принципов работы ботов](bot-builder-basics.md).
- Копия примера упреждающих сообщений для **[C#](https://aka.ms/proactive-sample-cs) или [JavaScript](https://aka.ms/proactive-sample-js)** . Этот пример используется в статье в качестве иллюстрации для упреждающего обмена сообщениями.

## <a name="about-the-proactive-sample"></a>Сведения о примере с упреждающими сообщениями

Этот пример содержит бот и дополнительный контроллер, который используется для отправки в бот упреждающих сообщений, как показано на следующем рисунке.

![Упреждающий бот](media/proactive-sample-bot.png)

## <a name="retrieve-and-store-conversation-reference"></a>Получение и сохранение ссылки на беседу

Когда эмулятор подключается к боту, этот бот получает два действия обновления беседы. В обработчике бота для действий обновления беседы извлекается ссылка на беседу, которая сохраняется в словаре, как показано ниже.

# <a name="ctabcsharp"></a>[C#](#tab/csharp)

**Bots\ProactiveBot.cs**

[!code-csharp[OnConversationUpdateActivityAsync](~/../botbuilder-samples/samples/csharp_dotnetcore/16.proactive-messages/Bots/ProactiveBot.cs?range=26-37&highlight=3-4,9)]

# <a name="javascripttabjavascript"></a>[JavaScript](#tab/javascript)

**bots/proactiveBot.js**

[!code-javascript[onConversationUpdateActivity](~/../botbuilder-samples/samples/javascript_nodejs/16.proactive-messages/bots/proactiveBot.js?range=13-17&highlight=2)]

[!code-javascript[onConversationUpdateActivity](~/../botbuilder-samples/samples/javascript_nodejs/16.proactive-messages/bots/proactiveBot.js?range=41-44&highlight=2-3)]

---

Примечание. В реальной системе ссылки на беседы следует хранить в базе данных, а не в объекте в памяти.

Ссылка на беседу имеет свойство _conversation_, в котором указано, к какой беседе относится действие. У беседы есть свойство _user_, которое содержит список пользователей, участвующих в беседе, а также свойство _service URL_, в котором каналы сохраняют URL-адрес для отправки ответов на текущее действие. Для отправки пользователям упреждающих сообщений нужно получить допустимую ссылку на беседу.

## <a name="send-proactive-message"></a>Отправка упреждающих сообщений

Второй контроллер (_notify_) отвечает за отправку в бот упреждающего сообщения. Чтобы создать упреждающее сообщение, выполните следующие действия.

1. Получите ссылку на беседу, в которую отправляется упреждающее сообщение.
1. Вызовите метод _продолжения беседы_ из адаптера, предоставив ссылку на беседу и делегат обработчика шагов, которые он сможет использовать. Метод продолжения беседы создает контекст шага для той беседы, на которую указывает ссылка, а затем вызывает указанный делегат обработчика шагов.
1. В этом делегате контекст шага используется для отправки упреждающего сообщения.

# <a name="ctabcsharp"></a>[C#](#tab/csharp)

**Controllers\NotifyController.cs**

При каждом запросе страницы уведомления бота соответствующий контроллер извлекает из словаря ссылки на беседы.
Этот контроллер выполняет методы `ContinueConversationAsync` и `BotCallback`, чтобы отправить упреждающее сообщение.

[!code-csharp[Notify logic](~/../botbuilder-samples/samples/csharp_dotnetcore/16.proactive-messages/Controllers/NotifyController.cs?range=17-59&highlight=28,40-43)]

Для отправки упреждающего сообщения адаптеру нужен идентификатор приложения бота. В рабочей среде для этого можно использовать реальный идентификатор приложения бота. В локальной тестовой среде подойдет любой произвольный идентификатор. Если боту еще не назначен идентификатор приложения, контроллер уведомления самостоятельно генерирует заполнитель и применяет его в вызове.

# <a name="javascripttabjavascript"></a>[JavaScript](#tab/javascript)

**index.js**

При каждом запросе страницы сервера `/api/notify` этот сервер извлекает из словаря ссылки на беседы.
Затем сервер выполняет метод `continueConversation`, чтобы отправить упреждающее сообщение.
Параметр `continueConversation` является функцией, которая используется как обработчик шага бота для этого шага.

[!code-javascript[Notify logic](~/../botbuilder-samples/samples/javascript_nodejs/16.proactive-messages/index.js?range=56-62&highlight=4-5)]

---

## <a name="test-your-bot"></a>Тестирование бота

1. Установите [Bot Framework Emulator](https://aka.ms/bot-framework-emulator-readme), если вы этого еще не сделали.
1. Выполните этот пример на локальном компьютере.
1. Запустите эмулятор и подключите его к боту.
1. Загрузите страницу бота api/notify. Это действие создает в эмуляторе упреждающее сообщение.

## <a name="additional-information"></a>Дополнительная информация

Кроме примера, который используется в этой статье, на [GitHub](https://github.com/Microsoft/BotBuilder-Samples/) есть и другие примеры для C# и JavaScript.

### <a name="avoiding-401-unauthorized-errors"></a>Предотвращение ошибки 401 Unauthorized (не авторизовано) 

По умолчанию пакет SDK BotBuilder добавляет `serviceUrl` в список имен доверенных узлов, если входящий запрос прошел проверку BotAuthentication. Эти данные сохраняются в кэше в памяти. При перезапуске бота все пользователи, ожидающие упреждающих сообщений, не смогут их получить, если не отправляли боту новые сообщения после перезапуска. 

Чтобы избежать этого, следует вручную добавить `serviceUrl` в список имен доверенных узлов, выполнив следующие действия. 

# <a name="ctabcsharp"></a>[C#](#tab/csharp)

```csharp 
MicrosoftAppCredentials.TrustServiceUrl(serviceUrl); 
``` 

Для упреждающего обмена сообщениями `serviceUrl` используется как URL-адрес канала, с которым взаимодействует получатель упреждающего сообщения. Его можно найти в `Activity.ServiceUrl`. 

Добавьте приведенный выше код прямо перед кодом, который отправляет упреждающее сообщение. В [примере упреждающих сообщений](https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/csharp_dotnetcore/16.proactive-messages) это нужно сделать в `NotifyController.cs` прямо перед `await turnContext.SendActivityAsync("proactive hello");`.

# <a name="javascripttabjavascript"></a>[JavaScript](#tab/javascript)

```js
MicrosoftAppCredentials.trustServiceUrl(serviceUrl);
```

Для упреждающего обмена сообщениями `serviceUrl` используется как URL-адрес канала, с которым взаимодействует получатель упреждающего сообщения. Его можно найти в `activity.serviceUrl`.

Добавьте приведенный выше код прямо перед кодом, который отправляет упреждающее сообщение. В [примере упреждающих сообщений](https://github.com/microsoft/BotBuilder-Samples/tree/master/samples/javascript_nodejs/16.proactive-messages) это нужно сделать в `index.js` прямо перед `await turnContext.sendActivity('proactive hello');`.

---

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Реализация процесса общения](bot-builder-dialog-manage-conversation-flow.md)
