---
title: Рекомендации по отладке | Документация Майкрософт
description: Узнайте, как выполнять отладку бота.
keywords: debugging bots, botframework debugging
author: ivorb
ms.author: kamrani
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.date: 07/17/2019
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: a04e1acc37c488fcd7530b7df2dd8668d4cfdcc2
ms.sourcegitcommit: a6d02ec4738e7fc90b7108934740e9077667f3c5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/04/2019
ms.locfileid: "70299194"
---
# <a name="debugging-guidelines"></a>Рекомендации по отладке

[!INCLUDE[applies-to](../includes/applies-to.md)]

Боты — это сложные приложения, где работают вместе много различных частей. Как и в любом другом сложном приложении, это может привести к некоторым нестандартным ошибкам или бот может вести себя иначе, чем ожидалось.

Отладка бота иногда может быть трудной задачей. У каждого разработчика есть собственный предпочтительный способ выполнения этой задачи. Приведенные ниже рекомендации — это предложения для использования, которые применяются к подавляющему большинству ботов.

Убедившись, что ваш бот работает надлежащим образом, выполните следующий шаг — подключите его к каналу. Чтобы сделать это, разверните бот на промежуточном сервере и создайте собственный клиент Direct Line, к которому будет подключен бот.
<!--IBTODO [Direct Line client](bot-builder-howto-direct-line.md)-->

Создание собственного клиента позволяет определить внутреннюю работу канала, а также специально тестировать ответ бота на обмен определенными действиями. После подключения к клиенту выполните тесты, чтобы настроить состояние вашего бота и проверить возможности. Если бот использует такую возможность, как распознавание речи, ее можно проверить с помощью этих каналов.

Используя и Emulator, и Веб-чат на портале Azure, можно узнать больше о взаимодействии бота с различными каналами.

Отладка бота выполняется как и у других многопоточных приложениях с возможностью настраивать точки останова или использовать такие возможности, как окно интерпретации. 

Боты следуют парадигме программирования, управляемой событиями. Получить правильное представление о ней может быть тяжело, если вы с ней не знакомы. Если состояние вашего бота не отслеживается, он многопоточный и работает с асинхронными вызовами и вызовами ожидания, это может вызвать непредвиденные ошибки. Так как отладка бота работает подобно другим многопоточным приложениям, мы обсудим некоторые вспомогательные предложения, средства и ресурсы.

## <a name="understanding-bot-activities-with-the-emulator"></a>Основные сведения о действиях бота с эмулятором

Бот имеет дело с различными типами [действий](bot-builder-basics.md#the-activity-processing-stack) помимо обычных действий с _сообщениями_. С помощью [эмулятора](../bot-service-debug-emulator.md) мы покажем, что это за действия, когда они выполняются и какие сведения они содержат. Понимание этих действий поможет вам создавать коды бота эффективно и позволит проверить, соответствуют ли вашим ожиданиям действия, которые отправляет и получает бот.

## <a name="saving-and-retrieving-user-interactions-with-transcripts"></a>Сохранение и извлечение данных о взаимодействии пользователя с расшифровками

Хранилище BLOB-объектов расшифровки предоставляет специальный ресурс, который позволяет [хранить и извлекать расшифровки](bot-builder-howto-v4-storage.md), содержащие сведения о взаимодействии пользователей с ботом.  

Кроме того, после сохранения вводимых пользователем данных при взаимодействии, с помощью _обозревателя хранилища_ Azure можно вручную просмотреть данные, содержащиеся в расшифровках, которые хранятся в соответствующем хранилище BLOB-объектов. В следующем примере показан открытый _обозреватель хранилищ_ из настроек для _mynewtestblobstorage_. Чтобы открыть сохраненные входные данные пользователя, выберите:    "Контейнер больших двоичных объектов" > "ChannelId" > "TranscriptId" > "ConversationId".

![Просмотр_сохраненного_текста_расшифровки](./media/examine_transcript_text_in_azure.png)

Откроется окно с сохраненными данными в формате JSON, которые ввел пользователь. Введенные пользователем данные сохраняются с ключом _text:_ .

## <a name="how-middleware-works"></a>Принципы работы ПО промежуточного слоя

[ПО промежуточного слоя](bot-builder-concept-middleware.md) может не быть интуитивно понятным при первой попытке использования, особенно в отношении продолжения или сокращения выполнения. ПО промежуточного слоя может выполняться в начале или в конце очереди с помощью вызова к делегату `next()`, который указывает, когда выполнение необходимо передать в логику бота. 

Если вы используете несколько компонентов ПО промежуточного слоя, делегат может передать выполнение в различные компоненты ПО промежуточного слоя, если ваш конвейер так ориентирован. Сведения о [конвейере ПО промежуточного слоя бота](bot-builder-concept-middleware.md#the-bot-middleware-pipeline) помогают разъяснить эту идею.

Если делегат `next()` не вызывается, это называется [маршрутизацией короткого замыкания](bot-builder-concept-middleware.md#short-circuiting). Это происходит, когда ПО промежуточного слоя выполняет текущее действие и определяет, что нет необходимости передавать выполнение. 

Знание о времени и причине сокращений ПО промежуточного слоя помогает определить, какие части ПО промежуточного слоя должны быть первыми в конвейере. Кроме того, знание о том, что произойдет, особенно важно при использовании встроенного ПО промежуточного слоя, предоставляемого пакетом SDK или другими разработчиками. Некоторые считают, что лучше сначала создать собственное ПО промежуточного слоя, чтобы немного поэкспериментировать, и лишь затем углубляться во встроенное ПО промежуточного слоя.

<!-- Snip: QnA was once implemented as middleware.
For example [QnA maker](bot-builder-howto-qna.md) is designed to handle certain interactions and short-circuit the pipeline when it does, which can be confusing when first learning how to use it.
-->

## <a name="understanding-state"></a>Сведения о состоянии

Отслеживание состояния является важной частью бота, особенно для сложных задач. В целом рекомендуется обрабатывать действия как можно быстрее, а также позволить обработке завершиться, чтобы состояние сохранялось. Действия могут отправляться в бот практически в одно и то же время, и это может привести к ошибкам из-за асинхронной архитектуры.

Самое главное — убедитесь, что состояние сохраняется тем способом, который соответствует вашим ожиданиям. В зависимости от того, где находится ваше сохраненное состояние, с помощью эмуляторов хранилища для [Cosmos DB](https://docs.microsoft.com/azure/cosmos-db/local-emulator) и [Хранилища таблиц Azure](https://docs.microsoft.com/azure/storage/common/storage-use-emulator) можно проверить это состояние, прежде чем использовать рабочее хранилище.

## <a name="how-to-use-activity-handlers"></a>Как использовать обработчики действий

Обработчики действий представляют еще один уровень сложности, так как каждое действие выполняется в независимом потоке (или рабочей роли в зависимости от языка). В зависимости от того, что делают обработчики, это может вызвать проблемы, где текущее состояние не соответствует вашим ожиданиям.

Встроенные состояния записываются в конце очереди, при этом все действия, создаваемые очередью, выполняются независимо от конвейера очереди. Часто это не имеет значения, но если обработчик действия изменяет состояние, необходимо перезаписать состояние, чтобы оно содержало изменение. В этом случае конвейер очереди может ожидать, пока действие завершит обработку до завершения, чтобы убедиться, что оно записывает правильные данные о состоянии для этой очереди.

Использование _действия отправки_ и его обработчиков сопряжено с одной проблемой. Обычный вызов _действия отправки_ из обработчика _действий при отправке_ приводит к бесконечному разветвлению потоков. Вы можете решить эту проблему, добавив дополнительные сообщения в исходящие данные или записав выходные данные в другое расположение (например, консоль или файл), чтобы избежать сбоя бота.

## <a name="next-steps"></a>Дополнительная информация

> [!div class="nextstepaction"]
> [Как выполнять модульное тестирование ботов](unit-test-bots.md)

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Отладка в Visual Studio](https://docs.microsoft.com/visualstudio/debugger/index)
* [Отладка, трассировка и профилирование](https://docs.microsoft.com/dotnet/framework/debug-trace-profile/) для Bot Framework
* Для методов, которые не нужно добавлять в рабочий код, используйте [ConditionalAttribute](https://docs.microsoft.com/dotnet/api/system.diagnostics.conditionalattribute?view=netcore-2.0)
* Для просмотра сетевого трафика используйте такие инструменты, как [Fiddler](https://www.telerik.com/fiddler)
* См. [сведения об устранении общих проблем](../bot-service-troubleshoot-bot-configuration.md) и другие статьи об устранении неполадок в этом разделе.
