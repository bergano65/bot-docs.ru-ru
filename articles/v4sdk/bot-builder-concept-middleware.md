---
title: ПО промежуточного слоя | Документация Майкрософт
description: Общие сведения о ПО промежуточного слоя и его использовании в пакете SDK бота.
keywords: ПО промежуточного слоя, конвейер ПО промежуточного слоя, короткий канал, использование ПО промежуточного слоя
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 05/24/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 9986ac7d46acfa94694456d653b91dd66c1f55f0
ms.sourcegitcommit: f95702d27abbd242c902eeb218d55a72df56ce56
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/19/2018
ms.locfileid: "39306487"
---
# <a name="middleware"></a>ПО промежуточного слоя

[!INCLUDE [pre-release-label](~/includes/pre-release-label.md)]

ПО промежуточного слоя — это просто класс, который находится между адаптером и логикой бота, добавленный в коллекцию промежуточного программного обеспечения адаптера во время инициализации. Пакет SDK позволяет писать собственное ПО промежуточного слоя или добавить повторно используемые его компоненты, созданные другими пользователями. Что можно делать в ПО промежуточного слоя? Почти все... Каждое входящее или исходящее действие бота проходит через ПО промежуточного слоя.

Адаптер обрабатывает и направляет входящие действия через конвейер ПО промежуточного слоя бота в логику бота, а затем обратно. Каждая последовательность действий входа и выхода бота, каждый компонент ПО промежуточного слоя может проверять или выполнять действие до и после запуска логики бота.

Прежде чем приступить к работе с ПО промежуточного слоя, важно понять суть [ботов в целом](~/v4sdk/bot-builder-basics.md) и [как они обрабатывают действия](~/v4sdk/bot-builder-concept-activity-processing.md).

## <a name="uses-for-middleware"></a>Использование ПО промежуточного слоя

Часто возникает вопрос: что входит в ПО промежуточного слоя по сравнению с логикой бота? ПО промежуточного слоя является достаточно гибким, поэтому в конечном счете оно зависит от вас. Давайте рассмотрим несколько преимуществ ПО промежуточного слоя.

### <a name="looking-at-or-acting-on-every-activity"></a>Просмотр каждого действия и его выполнение

Существует множество ситуаций, которые требуют от бота соответствующего поведения для каждого вида действий или для определенного типа действий. Например, нам необходимо зарегистрировать каждое действие сообщения, которое получает бот, или предоставить резервный ответ, если бот еще не создал ответ в этом действии. ПО промежуточного слоя — это отличное место для этого со способностью действовать как до, так и после выполнения остальной части логики бота.

### <a name="modifying-or-enhancing-the-turn-context"></a>Изменение или расширение контекста включения

Некоторые общения могут быть намного плодотворнее, если бот имеет больше информации, чем предусмотрено в этом действии. ПО промежуточного слоя в этом случае может просмотреть текущую информацию о состоянии общения, запросить источник внешних данных и добавить это к объекту контекста, прежде чем передавать выполнение логике бота.
Например, ПО промежуточного слоя может идентифицировать детали общения, такие как идентификатор и состояние общения, а затем запрашивать информацию у службы каталогов. ПО промежуточного слоя может добавлять объект пользователя, полученный от внешнего запроса, к объекту контекста и передавать его, предоставляя больше данных о пользователе и позволяя боту лучше обрабатывать запрос.

ПО промежуточного слоя может попадать в оба использования, указанных выше, или в другое использование полностью. Все зависит от того, как вы хотите структурировать бот и чего ему необходимо достичь.
ПО промежуточного слоя может устанавливать или сохранять состояние, реагировать на входящие запросы или сокращать канал конвейера.
Использование ПО промежуточного слоя.

- **Хранение или удерживание**. Используйте ПО промежуточного слоя для хранения или удерживания значений после возвращения или обновления некоторых значений, которые получились при возвращении.
- **Изящная обработка ошибок или сбоев**. Если выбрано исключение, ПО промежуточного слоя может отправлять удобное для использования сообщение для этого исключения.
- **Перевод**. Это ПО промежуточного слоя может обнаруживать и переводить на другой язык входящие сообщения и настраивать исходящие сообщения, которые будут переведены обратно на язык, обнаруженный при входе.

Можно определить свое собственное ПО промежуточного слоя, или пакет SDK определит ПО, которое представляет собой независящие от приложения компоненты, наподобие следующих.

- Состояние ПО промежуточного слоя, которое сохраняет и восстанавливает сведения о состоянии объекта контекста. Пакет SDK предоставляет ПО промежуточного слоя состояния общения и состояния пользователя.
- ПО промежуточного слоя перевода может распознать язык ввода и перевести на другой, понятный приложению, язык.
- Ведение журнала ПО промежуточного слоя, который может записывать входящие и исходящие действия.

## <a name="the-bot-middleware-pipeline"></a>Конвейер ПО промежуточного слоя бота

Адаптер вызывает ПО промежуточного слоя для каждого действия в том **порядке, в котором оно было добавлено**. Адаптер передает объект контекста для возвращения и _следующего_ делегата, а ПО промежуточного слоя вызывает делегат для передачи управления следующему промежуточному программному обеспечению в конвейере. ПО промежуточного слоя также имеет возможность выполнять действия после возвращения _следующего_ делегата до завершения метода. Можно представить, что каждый объект ПО промежуточного слоя имеет первую и последнюю возможность действовать в отношении объектов ПО промежуточного слоя, которые следуют за ним в конвейере.

Например: 

- Обработчик 1-го объекта ПО промежуточного слоя выполняет код перед вызовом _следующего_.
  - Обработчик 2-го объекта ПО промежуточного слоя выполняет код перед вызовом _следующего_.
    - Обработчик бота выполняет и возвращает.
  - Обработчик 2-го объекта ПО промежуточного слоя выполняет любой оставшийся код перед возвращением.
- Обработчик 1-го объекта ПО промежуточного слоя выполняет любой оставшийся код перед возвращением.

Если ПО промежуточного слоя не вызывает следующий делегат, адаптер не вызывает ни одно из последующих ПО или обработчиков бота, а также сокращается конвейер.

После завершения работы конвейера ПО промежуточного слоя бота возвращение завершается и его контекст выходит за пределы области.

ПО промежуточного слоя или бот могут создавать ответы и регистрировать обработчики событий ответа, но учитывайте, что ответы обрабатываются в отдельных процессах.

## <a name="order-of-middleware"></a>Порядок выполнения ПО промежуточного слоя

Поскольку порядок добавления ПО промежуточного слоя определяет порядок, в котором оно обрабатывает действие, важно определить последовательность добавления ПО промежуточного слоя.

> [!NOTE]
> Это дает общий шаблон, который работает для большинства ботов, но имейте ввиду, что каждая часть ПО промежуточного слоя будет взаимодействовать с другими частями.

Первыми действиями в конвейере ПО промежуточного слоя должны быть те, которые берут на себя задачи самого низкого уровня, которые используются постоянно. Примеры включают ведение журнала, обработку исключений, управление состоянием и перевод. Их порядок может варьироваться в зависимости от потребностей, например, нужно ли сначала переводить входящее сообщение, прежде чем можно будет обработать какие-либо исключения, или если обработка исключений будет первой, это может означать, что сообщения об исключениях не будут переведены.

Последним в конвейере ПО промежуточного слоя должен быть специальный бот ПО промежуточного слоя, который является программным обеспечением, реализующим выполнение обработки каждого сообщения, отправленного вашему боту. Если ПО промежуточного слоя использует информацию о состоянии или другую информацию, заданную в контексте бота, добавьте ее в конвейер программного обеспечения после того, как оно изменит состояние или контекст.

## <a name="short-circuiting"></a>Сокращение каналов

_Сокращение каналов_ является важной идеей для ПО промежуточного слоя (и [обработчиков событий](~/v4sdk/bot-builder-concept-activity-processing.md#response-event-handlers)). Если выполнение должно продолжаться через последующие слои, для этого требуется, чтобы ПО промежуточного слоя (или обработчик) передал выполнение через вызов _следующего_ делегата.  Если следующий делегат не вызывается в рамках ПО промежуточного слоя (или обработчика), текущий конвейер сократит канал и последующие слои не выполнятся. Это означает, что вся логика ботов и любое ПО промежуточного слоя в конвейере далее пропускается.

Пропуск вызова _следующего_ делегата в обработчике событий означает, что событие отменяется и значительно отличается от логики пропуска промежуточного программного обеспечения. Не обработав остальную часть события, адаптер никогда не отправит его.

> [!TIP]
> Если сократить канал события, например `SendActivities`, убедитесь, что это действие верное. В противном случае это может привести к ошибкам.

## <a name="next-steps"></a>Дополнительная информация

Теперь, когда вы знакомы с некоторыми ключевыми понятиями бота, давайте обсудим все аспекты того, как бот может отправлять упреждающие сообщения.

> [!div class="nextstepaction"]
> [Proactive messaging](~/v4sdk/bot-builder-proactive-messages.md) (Упреждающий обмен сообщениями)
