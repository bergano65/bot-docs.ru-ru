---
title: Сведения о навыках | Документация Майкрософт
description: Узнайте о том, как бот может использовать логику беседы из другого бота с помощью пакета SDK для Bot Framework.
keywords: навык бота, размещение бота, бот для навыков.
author: JonathanFingold
ms.author: kamrani
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.date: 12/09/2019
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: e512dbf7c7f31a0f2674fc1ea0e4ce825096c314
ms.sourcegitcommit: 772b9278d95e4b6dd4afccf4a9803f11a4b09e42
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2020
ms.locfileid: "80117708"
---
# <a name="about-skills"></a>Сведения о навыках

[!INCLUDE [applies-to-v4](../includes/applies-to.md)]

<!-- Value prop: why skills -->
Начиная с версии 4.7, пакет SDK для Bot Framework позволяет расширить возможности бота за счет другого бота (навыка).
Такой навык может использоваться несколькими другими ботами, что упрощает сценарии повторного использования логики. Также это позволяет создать бот, ориентированный на взаимодействие с пользователем, и дополнить его вашими собственными или сторонними навыками.

<!-- Terminology -->
- _Навыком_ здесь называется бот, который может выполнять ряд задач для другого бота.
  В зависимости от используемой архитектуры навык может также функционировать как обычный бот, взаимодействующий с пользователем.
- _Пользователь навыка_ — это бот, который взаимодействует с пользователем и умеет вызывать один или несколько навыков. В контексте использования _корневой бот_ — это потребитель навыка, который также взаимодействует с пользователем.
- _Манифест навыка_ — это файл в формате JSON с описанием действий, которые может выполнять навык, его входных и выходных параметров, а также конечных точек навыка.
  - Разработчики, у которых нет доступа к исходному коду навыка, могут использовать информацию из этого манифеста для разработки потребителя навыка. Пример манифеста навыка. см. в руководстве по [реализации навыка](./skill-implement-skill.md).
  - _Схема манифеста навыка_ — это файл в формате JSON с описанием схемы манифеста навыков. Текущая версия хранится в файле [skill-manifest-2.0.0.json](https://github.com/microsoft/botframework-sdk/blob/master/schemas/skills/skill-manifest-2.0.0.json).

Иными словами, пользователь напрямую взаимодействует только с корневым роботом, который делегирует навыку часть логики своей беседы.

<!-- Requirements/contract -->
Поддержка навыков реализована так, чтобы обеспечивать следующие возможности:

- навыки могут работать с адаптером Bot Framework и пользовательскими адаптерами;
- навыки могут работать с каналом Microsoft Teams, в котором активно используются действия `invoke`;
- навыки поддерживают проверку подлинности пользователей, но она выполняется локально в навыке или в потребителе навыка и не может быть передана в другой бот;
- потребитель навыка может использовать несколько навыков;
- потребитель навыка может выполнять несколько навыков одновременно;
- потребитель навыка может использовать навык при любых сочетаниях языков и версий пакета SDK;
- служба соединителя ботов выполняет проверку подлинности для взаимодействия между ботами, но вы можете проверить корневой бот локально с помощью эмулятора.
- Роль потребителя навыка может выполнять другой навык. Подключение через цепочку из нескольких навыков повышает задержку сети и риск возникновения ошибок. Такие боты являются более сложными, а их отладка может быть затруднительной.
<!--TBD: - Skills support proactive messaging. -->

## <a name="architecture"></a>Architecture

Навык и его потребитель размещаются в отдельных ботах и публикуются независимо друг от друга.

- Навык и его потребитель обмениваются данными по протоколу HTTP.
- Потребитель навыка может вызывать более одного навыка.
- Навык может вызываться более чем одним потребителем.

В навык нужно включить дополнительную логику для отправки действия `endOfConversation` после выполнения, чтобы потребитель навыка вовремя прекратил передачу действий в навык.

Корневой бот реализует по меньшей мере две конечные точки HTTP: одну для получения действий от пользователя и одну для получения действий от навыков. Потребитель навыка должен связать код, который получает HTTP-запросы методов, с обработчиком навыка.
Для этого нужно добавить дополнительную логику управления навыком, например для вызова или отмены навыка и т. д. Кроме обычных объектов бота и адаптера, потребитель включает несколько связанных с навыками объектов, которые используются для обмена действиями с навыком.

На этой схеме показан поток действий от пользователя через корневой бот до навыка и обратно.

![Диаграмма архитектуры](./media/skills-conceptual-architecture.png)

1. Адаптер корневого бота получает действия от пользователя и перенаправляет их обработчику действий корневого бота.
1. Корневой бот использует HTTP-клиент навыка, чтобы отправить действие в навык. Он получает сведения о беседе между потребителем и навыком, используя определение навыка и фабрику идентификаторов бесед с навыками. Сюда относится и URL-адрес службы, который используется навыком для ответа на действие.
1. Адаптер навыка получает действия от потребителя навыка и перенаправляет их обработчику действий навыка.
1. Когда навык отправляет ответ, обработчик навыка корневого бота получает соответствующее действие. Он получает сведения о беседе между корневым ботом и пользователем из фабрики идентификаторов бесед с навыками. Затем оп передает действие в адаптер корневого бота.
1. Этот адаптер создает упреждающее сообщение самому себе, чтобы возобновить беседу с пользователем.
1. Адаптер корневого бота отправляет пользователю все сообщения, полученные от навыка.

Следующие объекты помогают управлять навыками и перенаправлять трафик от них:

- _Навык Bot Framework_ описывает сведения о маршрутизации для навыка и считывается из файла конфигурации потребителя навыка.
- _HTTP-клиент навыка_ отправляет действия в навык.
- _Обработчик навыка_ получает действия от навыка.
- _Фабрика идентификаторов диалога для навыков_, преобразует ссылки между беседами пользователя с корневым ботом и корневого бота с навыком.
- Служба Bot Connector реализует проверку подлинности для канала и для взаимодействия между ботами. С помощью объекта _конфигурации проверки подлинности_ вы можете добавить проверку утверждений в бот (потребитель или навык), чтобы ограничить доступ к нему приложениям или пользователям.

В объектах клиента навыка и обработчика навыка используется _фабрика идентификаторов бесед_ для преобразования между беседой, которую корневой бот использует для взаимодействия с пользователем, и беседой для взаимодействия корневого бота с навыком.

## <a name="bot-to-bot-communication"></a>Взаимодействие между ботами

Независимо от того, какой бот вы разрабатываете, важно понимать некоторые аспекты этой архитектуры.

<!--
- infrastructure concerns:
  - stateless, cross-server application (memory management and middleware).
  - authentication, in both directions, plus claims validation.
- implementation concerns:
  - classes, objects, and logic you need to add to your host (and skill).
  - when to start and stop a skill.
  - managing multiple skills.
-->

### <a name="conversation-references"></a>Ссылки на беседы

Для взаимодействия корневого бота с пользователем и навыком используются разные беседы.

_Фабрика идентификаторов бесед_ помогает управлять трафиком между потребителем навыка и навыком. Эта фабрика преобразует идентификаторы бесед, которые корневой бот использует с пользователем и навыком.
Другими словами, она создает идентификатор беседы между корневым ботов и навыком, и восстанавливает исходный идентификатор беседы корневого бота с пользователем из идентификатора беседы с навыком.

<!-- Hopefully, this just gets folded into the SDK and does not need to get described in detail.
- The host needs to save or encode original conversation ID and service URL and create a conversation ID for use between it and the skill.
  - Generated conversation IDs must be usable as a URL path parameter.
  - A modified activity gets the new conversation ID and service URL (of the host, as the host provides a channel interface to the skill).
- Upon receiving an activity from the skill, host needs to decode or recover the original conversation ID and service URL so that the activity can get forwarded back to the user in the original conversation.
-->

### <a name="cross-server-coordination"></a>Координация между серверами
<!-- or, Statelessness in the host -->

Корневой бот и навык обмениваются данными по протоколу HTTP.
Это означает, что действие от навыка может получать не тот экземпляр, который отправил начальное действие, т. е. эти два запроса могут обрабатываться на разных серверах.

- Всегда сохраняйте состояние в потребителе навыка, прежде чем перенаправлять действие в навык.
  Это позволит экземпляру, который получит трафик от навыка, продолжить работу, после того как ее остановил предыдущий экземпляр перед вызовом навыка.
- Когда обработчик навыка получает действие от навыка, он преобразует его в форму, подходящую для потребителя навыка, и перенаправляет его в адаптер этого потребителя.

### <a name="skill-consumer-and-skill-state"></a>Потребитель и состояние навыка

Навык и его потребитель управляют своими состояниями независимо друг от друга. Впрочем, потребитель создает идентификатор беседы, которую он использует для обмена данными с навыком. Это может повлиять на состояние беседы в навыке.

> [!IMPORTANT]
> Как отмечалось ранее, когда потребитель навыка передает в навык действие пользователя, ответ от этого навыка может получить другой экземпляр потребителя. Потребителю следует всегда сохранять состояние беседы непосредственно перед тем, как перенаправить действие в навык.

### <a name="bot-to-bot-authentication"></a>Аутентификация взаимодействия между ботами

<!-- TODO Add appropriate info about this new(?) feature to the bot basics article. -->

Проверка подлинности на уровне службы выполняется службой Bot Connector. Эта платформа использует токены носителя и идентификаторы приложения бота для идентификации каждого бота.

Bot Framework использует объект _конфигурации проверки подлинности_ для проверки заголовков проверки подлинности во входящих запросах.

#### <a name="claims-validation"></a>Проверка утверждений

В конфигурацию проверки подлинности можно добавить _средство проверки утверждений_. Утверждения оцениваются после заголовка проверки подлинности. Код средства проверки должен создавать исключение или ошибку, чтобы отклонить запрос.

Отклонение запроса, уже прошедшего проверку подлинности, может потребоваться по разным причинам:

- потребитель навыка должен принимать трафик только от навыков, с которыми он сам начинал беседу;
- навык входит в состав платной службы и к нему не должны иметь доступ пользователи, отсутствующие в базе данных;
- вы хотите ограничить доступ к навыку для конкретных потребителей.

<!--TODO Need a link for more information about claims and claims-based validation.-->

## <a name="skill-consumers"></a>Потребители навыка

<!--
### Skill consumer design
Supports: Bot Framework adapter, custom adapters, MS Teams channel (what Teams calls "proactive" 1-1 conversations, created off a group/channel/team conversation)
-->

С точки зрения пользователя взаимодействие выполняется только с корневым ботом.
С точки зрения навыка потребителем является канал, по которому он обменивается данными с пользователем.

Корневой бот выполняет роль потребителя навыка, и для этого ему нужна дополнительная логика управления трафиком между собой и навыком:

- Сведения о конфигурации для каждого навыка, который используется корневым ботом.
- _Фабрика идентификаторов бесед_, которая позволяет корневому боту переключаться между беседами, которые он поддерживает с пользователем и с навыком.
- _Клиент навыка_, который может упаковывать действия и переадресовывать их боту навыка.
- _Обработчик навыка_, который может принимать действия от бота навыка и распаковывать их.

### <a name="managing-skills"></a>Управление навыками

Запуск навыка и поддержка его выполнения до завершения работы требуют реализации некоторых дополнений на узле выполнения. Поддерживаются и более сложные сценарии, например с несколькими навыками или потоками бесед.

#### <a name="skill-descriptions"></a>Описания навыков

Для каждого навыка добавьте объект _навыка Bot Framework_ в файл конфигурации потребителя навыка. Каждый из них содержит идентификатор, идентификатор приложения и конечную точку для навыка.

| Свойство | Описание
| :--- | :--- |
| _Идентификатор_ | Идентификатор или ключ навыка, относящийся к конкретному потребителю навыка. |
| _Идентификатор приложения_ | Идентификатор `appId`, назначенный ресурсу бота при регистрации навыка в Azure. |
| _Конечная точка навыка_ | Конечная точка обмена сообщениями для навыка. Это URL-адрес, с которым будет взаимодействовать потребитель для работы с навыком. |

#### <a name="skill-client-and-skill-handler"></a>Клиент навыка и обработчик навыка

<!-- Is this still accurate? -->
Потребитель навыка использует клиент навыка для отправки действий в навык. Клиент выполняет следующее:

- принимает действие, которое нужно переадресовать в навык, полученное от пользователя или созданное потребителем;
- заменяет исходную ссылку на беседу другой, которая соответствует беседе между потребителем и навыком;
- добавляет токен проверки подлинности между ботами;
- отправляет обновленное действие в навык.

Потребитель навыка использует обработчик навыка для получения действий от навыка. Этот обработчик выполняет следующее:

- обрабатывает методы `SendToConversation` и `ReplyToActivity` REST API службы канала;
- применяет проверку подлинности и проверку утверждений;
- получает ссылку на исходную беседу;
- создает действие для адаптера потребителя. Это действие подает сигнал о завершении навыка или передается пользователю.

<!-- These section should probably reference a how-to. -->
#### <a name="managing-a-skill-from-a-skill-consumer"></a>Управление навыком из потребителя навыка

Вам нужно добавить в потребитель навыков логику, которая отслеживает активные навыки.
Именно от потребителя зависит, как выполняется управление навыками в целом, поддерживается ли параллельная работа нескольких активных навыков и т. д.
Следует оценить несколько конкретных сценариев:

- Создание новой беседы между потребителем и навыком. (Она будет связана с конкретной беседой между потребителем и пользователем.)
  - Чтобы передать параметры навыку, установите значение свойства _value_ в исходном действии, которое передается этому навыку.
- Продолжение существующей беседы между потребителем и навыком.
- Распознавание действия `endOfConversation`, полученного от навыка, как сигнала для окончания беседы между потребителем и навыком.
  - Чтобы получить значения, возвращаемые из навыка, проверьте свойство _value_ действия.
  - Чтобы узнать причину завершения навыка, проверьте параметр _code_, который может сообщить об ошибке, возникшей в навыке.
- Отмена навыка из потребителя путем отправки действия `endOfConversation` в навык.

#### <a name="invoking-a-skill-from-a-dialog"></a>Вызов навыка из диалога

Если вы используете [библиотеку диалогов](bot-builder-concept-dialog.md), для управления навыком можно использовать _диалог навыка_. Активным диалогом будет считаться диалог навыка, но все действия он будет пересылать связанному навыку.
<!--Language-specific Notes:
- C#: SkillDialog, SkillDialogOptions, SkillDialogArgs
  - public SkillDialog(SkillDialogOptions dialogOptions, string dialogId = null)
- JS: SkillDialog, SkillDialogOptions, BeginSkillDialogOptions
  - public constructor(dialogOptions: SkillDialogOptions, dialogId?: string)
- Py (WIP): SkillDialog, SkillDialogOptions, SkillDialogArgs
  - def __init__(self, dialog_options: SkillDialogOptions, conversation_state: ConversationState)
-->

- При создании диалога навыка используйте параметр _dialog options_, чтобы предоставить всю информацию, которая потребуется этому диалогу для управления навыком, в том числе идентификатор приложения потребителя, URL-адрес обратного вызова, фабрика идентификаторов беседы, свойства навыка и т. п.
  - Если вам нужно управлять в диалоге несколькими навыками, следует создать отдельный диалог для каждого навыка.
  - Часто вы будете добавлять диалог навыка в компонентный диалог.
- Чтобы открыть диалог навыка, вызовите метод _begin_ из контекста диалога окна и укажите идентификатор диалога навыка. С помощью параметра _options_ укажите действие, которое потребитель будет передавать в качестве первого действия для навыка.
- Диалог навыка можно отменить или прервать, как любой другой диалог. Пример см. в статье [Обработка прерываний со стороны пользователя](bot-builder-howto-handle-user-interrupt.md).

## <a name="skill-bots"></a>Боты навыков

Любой бот с незначительными изменениями может выполнить роль навыка. Боты навыков выполняют следующее:

- реализуют ограничения доступа через средство проверки утверждений;
- если это требуется, проверяют параметры инициализации в свойстве _value_ исходного действия;
- отправляют сообщения пользователю обычным образом через действия `message`;
- сообщают о завершении или отмене выполнения через действие `endOfConversation`;
  - предоставляют возвращаемое значение, если оно есть, в свойстве _value_ отправляемого действия;
  - предоставляют код ошибки, если это применимо, в свойстве _code_ отправляемого действия.

### <a name="skill-activities"></a>Действия навыка

 Некоторые навыки могут выполнять разные задачи или _действия_. Например, навык "список задач" может поддерживать действия создания, обновления, просмотра и удаления, которые можно рассматривать как отдельные беседы. <!--TODO Flesh this out-->

### <a name="skill-manifest"></a>Манифест навыка

Так как потребитель навыка не всегда имеет доступ к коду этого навыка, опишите в манифесте все действия, которые ваш навык умеет получать и создавать, все его входные и выходные параметры, а также конечные точки. См. сведения о [схеме манифеста навыка (skill-manifest-2.0.0.json)](https://github.com/microsoft/botframework-sdk/blob/master/schemas/skills/skill-manifest-2.0.0.json).

## <a name="additional-information"></a>Дополнительные сведения

См. сведения о том, как реализовать [навыки](skill-implement-skill.md) и [боты потребителей навыков](skill-implement-consumer.md).

<!--
You publish skill and skill consumer bots separately. For more information, see _TBD: link to create a skills bot from scratch how-to or tutorial_.

For more about skill manifests, see the _TBD: creating a manifest section of implementing a skill bot_.
-->
