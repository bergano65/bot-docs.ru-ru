---
title: Устранение неполадок — Служба Azure Bot
description: Устранение общих проблем в процессе разработки ботов с помощью ответов на часто задаваемые технические вопросы.
author: DeniseMak
ms.author: kamrani
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.date: 02/20/2020
ms.openlocfilehash: 6df2b5322233d905b2896ea93b77ba03516e6162
ms.sourcegitcommit: 54d3febefaf0072172b17bd8e4ec456264dfbd42
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/21/2020
ms.locfileid: "77521497"
---
# <a name="troubleshooting-general-problems"></a>Устранение общих проблем
Ответы на эти часто задаваемые вопросы помогут вам устранить распространенные проблемы, связанные с разработкой или эксплуатацией ботов.

## <a name="how-can-i-troubleshoot-issues-with-my-bot"></a>Как можно устранить неполадки с ботом?

1. Выполните отладку исходного кода бота в [Visual Studio Code](debug-bots-locally-vscode.md) или [Visual Studio](https://docs.microsoft.com/visualstudio/debugger/navigating-through-code-with-the-debugger?view=vs-2017).
1. Перед развертыванием в облаке протестируйте бот с помощью [эмулятора](bot-service-debug-emulator.md).
1. Разверните бот на облачной платформе размещения, например Azure, а затем проверьте возможность подключения к боту с помощью встроенного элемента управления веб-чата на панели мониторинга бота на <a href="https://portal.azure.com" target="_blank">портале Azure</a>. Если после развертывания в Azure с ботом возникнут проблемы, просмотрите следующую запись блога: [Understanding Azure troubleshooting and support](https://azure.microsoft.com/blog/understanding-azure-troubleshooting-and-support/) (Общие сведения об устранении неполадок и включении поддержки в Azure).
1. Исключите [аутентификацию][TroubleshootingAuth] как возможную проблему.
1. Протестируйте работу бота в Web Chat, Teams или любом другом канале, который вы будете использовать с этим ботом. Это поможет проверить полное взаимодействие с пользователем.
1. Протестируйте бот в каналах с требованиями дополнительной проверки подлинности, таких как Direct Line или веб-чат.
1. Воспользуйтесь инструкциями по [отладке бота](bot-service-debug-bot.md) и прочитайте другие статьи об отладке в этом разделе.

## <a name="how-can-i-troubleshoot-authentication-issues"></a>Как устранить неполадки, связанные с проверкой подлинности?

Дополнительные сведения об устранении неполадок бота, связанных с аутентификацией, см. в статье [Устранение неполадок проверки подлинности Bot Framework][TroubleshootingAuth].

## <a name="im-using-the-bot-framework-sdk-for-net-how-can-i-troubleshoot-issues-with-my-bot"></a>Я использую пакет SDK Bot Framework для .NET. Как можно устранить неполадки с ботом?

**Просмотрите исключения.**  
В Visual Studio 2019 щелкните **Отладка** > **Windows** > **Параметры исключений**. В окне **Параметры исключений** установите флажок **Break When Thrown** (Прерывать при возникновении) рядом с полем **Исключения среды CLR**. При наличии возникших или необработанных исключений в окне выходных данных могут отображаться результаты диагностики.

**Просмотрите стек вызовов.**  
В Visual Studio можно выбрать вариант отладки [Только мой код](https://msdn.microsoft.com/library/dn457346.aspx). После изучения всего стека вызовов вы сможете глубже понять любую проблему.

**Убедитесь, что все методы диалога заканчиваются планом по обработке следующего сообщения.**  
Все шаги диалога должны передавать управление следующему шагу каскада или завершать текущий диалог для выхода из стека. Если шаг обрабатывается неправильно, беседа будет проходить не так, как вы ожидаете. Прочитайте статью о [концепциях диалогов](v4sdk/bot-builder-concept-dialog.md), чтобы лучше изучить эту тему.


## <a name="what-causes-an-error-with-http-status-code-429-too-many-requests"></a>Почему возникает ошибка с кодом состояния HTTP 429 "Слишком много запросов"?

Сообщение об ошибке с кодом состояния HTTP 429 указывает, что в течение заданного промежутка времени было отправлено слишком много запросов. Текст ответа должен содержать описание проблемы. В нем также может указываться минимальный обязательный интервал между запросами. Среди прочего, эта ошибка может возникать из-за средства [ngrok](https://ngrok.com/). Если вы используете бесплатный план и достигли пределов ngrok, перейдите на веб-страницу с ценами и ограничениями, чтобы изучить дополнительные [варианты](https://ngrok.com/product#pricing). 

## <a name="why-arent-my-bot-messages-getting-received-by-the-user"></a>Почему сообщения моего бота не попадают к пользователю?

Действие сообщения, создаваемое в ответе, следует правильно направить, иначе оно не будет поступать в нужное место назначения. В подавляющем большинстве случаев это не нужно обрабатывать явным образом; пакет SDK берет на себя адресацию действий сообщения. 

Правильная адресация действия подразумевает наличие правильного *идентификатора беседы* и сведений об отправителе. В большинстве случаев действие сообщения отправляется в ответ на поступившее сообщение. Это означает, что все данные для направления можно получить из входящего действия. 

Изучив трассировки или журналы аудита, можно убедиться в правильности направления сообщений. Если что-то работает неправильно, создайте в боте точку останова и проверьте, где для сообщения задаются идентификаторы.

## <a name="how-can-i-run-background-tasks-in-aspnet"></a>Как выполнять фоновые задачи в ASP.NET? 

В некоторых случаях может потребоваться запустить асинхронную задачу, которая в течение нескольких секунд находится в режиме ожидания, а затем выполняет код для очистки профиля пользователя или сброса состояния диалога или беседы. Дополнительные сведения о том, как это сделать, см. в статье о [выполнении фоновых задач в ASP.NET](https://www.hanselman.com/blog/HowToRunBackgroundTasksInASPNET.aspx). В частности, рассмотрите возможность использования [HostingEnvironment.QueueBackgroundWorkItem](https://msdn.microsoft.com/library/dn636893(v=vs.110).aspx). 

## <a name="my-bot-is-slow-to-respond-to-the-first-message-it-receives-how-can-i-make-it-faster"></a>Мой бот медленно реагирует на первое получаемое сообщение. Как повысить его быстродействие?

Боты представляют собой веб-службы, и некоторые платформы размещения, включая Azure, автоматически вводят службу в спящий режим, если она не получает трафик в течение определенного периода времени. Если это происходит с вашим ботом, его необходимо перезапустить с нуля при очередном получении сообщения, значительно замедляющего его ответ по сравнению с тем, как если бы он был уже запущен.

Некоторые платформы для размещения позволяют настроить службу таким образом, чтобы ее было невозможно перевести в спящий режим. Если бот размещается в службе веб-приложений Azure Bot, перейдите к службе бота на [портале Azure](https://portal.azure.com), щелкните **Параметры приложения**, а затем — **Всегда включено**. Этот параметр доступен в большинстве, но не во всех планах обслуживания.

## <a name="how-can-i-guarantee-message-delivery-order"></a>Как гарантировать определенный порядок доставки сообщений?

По возможности Bot Framework будет поддерживать порядок доставки сообщений. Например, если вы отправили сообщение A и ожидаете завершения этой операции HTTP, прежде чем инициировать новую операцию HTTP для отправки сообщения B. Некоторые каналы, такие как SMS и электронная почта, не гарантируют порядок доставки сообщений на устройство пользователя. 

## <a name="why-are-parts-of-my-message-text-being-dropped"></a>Почему отбрасываются части текста сообщения?

Bot Framework и многие каналы интерпретируют текст так, как если бы он был отформатирован с помощью [Markdown](https://en.wikipedia.org/wiki/Markdown). Проверьте, содержит ли текст символы, которые могут быть интерпретированы как синтаксис Markdown.

## <a name="how-can-i-support-multiple-bots-at-the-same-bot-service-endpoint"></a>Каким образом можно поддерживать несколько ботов в одной конечной точке службы ботов? 

В этом [примере](https://github.com/Microsoft/BotBuilder/issues/2258#issuecomment-280506334) показана настройка `Conversation.Container` с правильным классом `MicrosoftAppCredentials` и использование простого `MultiCredentialProvider` для проверки подлинности нескольких идентификаторов приложений и паролей.

## <a name="identifiers"></a>Идентификаторы

## <a name="how-do-identifiers-work-in-the-bot-framework"></a>Как работают идентификаторы в Bot Framework?

Дополнительные сведения об идентификаторах в Bot Framework см. в [этом руководстве][BotFrameworkIDGuide].

## <a name="how-can-i-get-access-to-the-user-id"></a>Как получить доступ к идентификатору пользователя?

Каналы Bot Framework предоставляют идентификатор пользователя в поле `from.Id` для любого действия, отправленного пользователем. SMS-сообщения и сообщения электронной почты предоставляют в этом свойстве необработанный идентификатор пользователя. В других каналах, например Skype, свойство `from.Id` маскируется и содержит уникальный идентификатор пользователя, который отличается от идентификатора пользователя Skype. Чтобы подключиться к существующей учетной записи, можно использовать карточку для входа и реализовать собственный поток OAuth для подключения идентификатора пользователя к своему ИД пользователя службы.

## <a name="why-are-my-facebook-user-names-not-showing-anymore"></a>Почему имена пользователей Facebook больше не отображаются?

Вы меняли пароль для Facebook? Если да, маркер доступа будет недействителен, и вам потребуется обновить параметры конфигурации бота для канала Facebook Messenger на <a href="https://portal.azure.com" target="_blank">портале Azure</a>.

## <a name="why-is-my-kik-bot-replying-im-sorry-i-cant-talk-right-now"></a>Почему бот Kik отвечает: "К сожалению, я не могу сейчас говорить"?

Боты для Kik поддерживаются для 50 подписчиков. После того как с ботом пообщалось 50 уникальных пользователей, любой новый пользователь, который пытается завести разговор с ботом, получит сообщение "К сожалению, я не могу сейчас говорить". Дополнительные сведения см. в [документации по Kik](https://botsupport.kik.com/hc/articles/225764648-How-can-I-share-my-bot-with-Kik-users-while-in-development-).

## <a name="how-can-i-use-authenticated-services-from-my-bot"></a>Как использовать прошедшие проверку подлинности службы из бота?

Сведения о добавлении проверки подлинности Azure Active Directory см. в статье, относящейся к выпуску пакета SDK [версии 3](https://docs.microsoft.com/azure/bot-service/bot-builder-tutorial-authentication?view=azure-bot-service-3.0&tabs=csharp) | [версии 4](https://docs.microsoft.com/azure/bot-service/bot-builder-tutorial-authentication?view=azure-bot-service-4.0&tabs=csharp). 

> [!NOTE] 
> При добавлении в бот функций проверки подлинности и безопасности следует убедиться, что шаблоны, реализуемые в коде, соответствуют стандартам безопасности, которые подходят для вашего приложения.

## <a name="how-can-i-limit-access-to-my-bot-to-a-pre-determined-list-of-users"></a>Как можно предоставить доступ к боту только предопределенному списку пользователей?

Некоторые каналы, такие как SMS и электронная почта, предоставляют неограниченный диапазон адресов. В этих случаях сообщения от пользователя будут содержать неформатированный идентификатор пользователя в свойстве `from.Id`.

Другие каналы, например Skype, Facebook и Slack, предоставляют адреса с областью действия или клиентские адреса таким образом, чтобы не позволить боту заранее прогнозировать идентификатор пользователя. В этих случаях будет необходимо проверить подлинность пользователя через ссылку для входа или общий секрет, чтобы определить, авторизованы ли они для использования бота.

## <a name="why-does-my-direct-line-11-conversation-start-over-after-every-message"></a>Почему диалог Direct Line 1.1 начинается заново после каждого сообщения?

> [!NOTE]
> 
> Этот раздел не применим к последней версии протокола Direct Line 3.0 

Если диалог Direct Line начинается заново после каждого сообщения, скорее всего, свойство `from` отсутствует или имеет значение `null` в сообщениях, которые клиент Direct Line отправил боту. Когда клиент Direct Line отправляет сообщение с отсутствующим или имеющим значение `null` свойством `from`, служба Direct Line автоматически выделяет идентификатор, поэтому каждое отправляемое клиентом сообщение будет считаться сообщением от нового пользователя.

Чтобы устранить эту проблему, задайте свойству `from` в каждом сообщении, отправленном клиентом Direct Line, постоянное значение, однозначно представляющее пользователя, который отправляет сообщение. Например, если пользователь уже выполнил вход на веб-страницу или в приложение, этот существующий идентификатор можно использовать в качестве значения свойства `from` в сообщениях, отправляемых пользователем. Кроме того, можно создать произвольный идентификатор пользователя при загрузке страницы или загрузке приложения, сохранить этот идентификатор в файле cookie или состоянии устройства и использовать его в качестве значения свойства `from` в сообщениях, отправляемых пользователем.

## <a name="what-causes-the-direct-line-30-service-to-respond-with-http-status-code-502-bad-gateway"></a>По какой причине служба Direct Line 3.0 отвечает с кодом состояния HTTP 502 "Недопустимый шлюз"?
Direct Line 3.0 возвращает код состояния HTTP 502 при попытке связаться с ботом, но запрос завершается ошибкой. Эта ошибка означает, что либо бот вернул ошибку, либо истекло время ожидания запроса. Чтобы получить дополнительные сведения об ошибках, возникающих в боте, перейдите к панели мониторинга бота на <a href="https://portal.azure.com" target="_blank">портале Azure</a> и щелкните ссылку "Проблемы" для затронутых каналов. Если для бота настроена служба Application Insights, в ней вы также сможете найти подробные сведения об ошибке. 

::: moniker range="azure-bot-service-3.0"

## <a name="where-is-conversation-state-stored"></a>Где хранится состояние диалога?

Данные в наборах свойств пользователя, диалога и частного диалога хранятся с использованием интерфейса `IBotState` соединителя. Каждый набор свойств ограничен идентификатором бота. Набор свойств пользователя помечается ключом идентификатора пользователя, набор свойств диалога помечается ключом идентификатора диалога и набор свойств частного диалога помечается ключами идентификатора пользователя и идентификатора диалога. 

Если для создания бота используется пакет SDK Bot Framework для .NET или пакет SDK Bot Framework для Node.js, стек диалога и данные диалога автоматически сохраняются как записи в наборе свойств частного диалога. В реализации C# применяется двоичная сериализация, а в реализации Node.js — сериализация JSON.

Чтобы хранить эти данные в центрах обработки данных, предоставьте пользовательскую реализацию службы состояния. Это можно сделать по меньшей мере двумя способами.

* Использовать пакеты botbuilder-azure.
* Использовать уровень REST для предоставления настраиваемой службы `IBotState`.
* Использовать интерфейсы построителя на уровне языка (C#, JavaScript или Python).

## <a name="what-causes-an-error-with-http-status-code-412-precondition-failed-or-http-status-code-409-conflict"></a>Почему возникает ошибка с кодом состояния HTTP 412 "Необходимое условие не выполнено" или с кодом состояния HTTP 409 "Конфликт"?

Служба `IBotState` соединителя используется для хранения наборов данных бота (т. е. наборов данных пользователя, диалога и частных данных бота, где набор частных данных бота содержит состояние "поток управления" стека диалога). Управление параллелизмом в службе `IBotState` осуществляет механизм оптимистичного параллелизма посредством тегов ETag. Если во время последовательности чтения, изменения и записи возникает конфликт обновления (из-за одновременного обновления набора данных одного бота), происходит следующее:

* если теги ETag сохраняются, в службе `IBotState` возникает ошибка с кодом состояния HTTP 412 "Необходимое условие не выполнено". Это поведение по умолчанию в пакете SDK Bot Framework для .NET.
* если теги ETag не сохраняются (т. е. ETag имеет значение `\*`), вступает в силу политика приоритета последней записи, которая исключает возникновение ошибки "Необходимое условие не выполнено", но приводит к риску потери данных. Это поведение по умолчанию в пакете SDK Bot Framework для Node.js.

## <a name="how-can-i-fix-precondition-failed-412-or-conflict-409-errors"></a>Как можно устранить ошибки "Необходимое условие не выполнено" (412) или "Конфликт" (409)?

Эти ошибки указывают, что бот за один раз обрабатывал несколько сообщений для одного диалога. Если бот подключен к службам, которым требуются точно упорядоченные сообщения, рекомендуется заблокировать состояние диалога, чтобы исключить параллельную обработку сообщений. 

В пакете SDK Bot Framework для .NET доступен механизм (класс `LocalMutualExclusion`, реализующий `IScope`) для пессимистической сериализации обработки отдельных диалогов с помощью семафора в памяти. Эту реализацию можно расширить за счет использования аренды Redis, ограниченной адресом диалога.

Если бот не подключен к внешним службам или если допускается параллельная обработка сообщений из одного диалога, можно добавить этот код, чтобы игнорировать конфликты, возникающие в API службы состояния бота. В этом случае последний ответ будет задавать состояние диалога.

```cs
var builder = new ContainerBuilder();
builder
    .Register(c => new CachingBotDataStore(c.Resolve<ConnectorStore>(), CachingBotDataStoreConsistencyPolicy.LastWriteWins))
    .As<IBotDataStore<BotData>>()
    .AsSelf()
    .InstancePerLifetimeScope();
builder.Update(Conversation.Container);
```

## <a name="how-do-i-version-the-bot-data-stored-through-the-state-api"></a>Как назначить версию данным бота, сохраненным с помощью API состояния?

> [!IMPORTANT]
> API службы состояния Bot Framework не рекомендуется использовать для рабочей среды или ботов, созданных с помощью пакета SDK версии 4. Этот API может считаться нерекомендуемым в будущем выпуске. Рекомендуется обновить код бота для использования хранилища в памяти в целях тестирования или использовать одно из **расширений Azure** для ботов в рабочей среде. Дополнительные сведения см. в статье об [управлении данными состояния](v4sdk/bot-builder-howto-v4-state.md).

Служба состояния позволяет сохранять ход беседы с помощью диалогов, чтобы пользователь мог вернуться к разговору с ботом без потери места, в котором была сделана остановка. В этом случае наборы свойств данных бота, сохраненные с помощью API состояния, не удаляются автоматически при изменении кода бота. Учитывая совместимость измененного кода с прежними версиями данных, нужно принять решение о необходимости удаления данных бота. 

* Чтобы вручную сбросить стек и состояние диалога в беседе во время разработки бота, используйте команду `/deleteprofile` для удаления данных о состоянии. Обязательно включите в команду начальный пробел, чтобы запретить каналу ее интерпретацию.
* После развертывания бота в рабочей среде можно назначить версию его данным, чтобы в случае изменения версии все связанные данные о состоянии удалялись. При работе с пакетом SDK Bot Framework для Node.js это можно сделать с помощью ПО промежуточного слоя, а при работе с пакетом SDK Bot Framework для .NET — с помощью реализации `IPostToBot`.

> [!NOTE]
> Если стек диалога не удается правильно десериализовать из-за изменений формата сериализации или слишком серьезного изменения кода, состояние беседы будет сброшено.

::: moniker-end

## <a name="why-do-i-get-an-authorization_requestdenied-exception-when-creating-a-bot"></a>Почему при создании бота возникает исключение Authorization_RequestDenied?

Управление разрешениями на создание ботов службы ботов Azure осуществляется на портале Azure Active Directory (AAD). Если на [портале AAD](https://aad.portal.azure.com) неправильно настроены разрешения, при попытке создать службу бота пользователи будут получать исключение **Authorization_RequestDenied**.

Сначала проверьте, являетесь ли вы гостевым пользователем каталога.

1. Войдите на [портал Azure](https://portal.azure.com).
2. Выберите **Все службы** и выполните поиск по слову *активный*.
3. Выберите **Azure Active Directory**.
4. Выберите раздел **Пользователи**.
5. В списке найдите пользователя и убедитесь, что в колонке **Тип пользователя** не указано значение **Гость**.

![Тип пользователя Azure Active Directory](~/media/azure-active-directory/user_type.png)

После проверки, подтверждающей, что вы не являетесь **гостевым пользователем**, нужно убедиться, что пользователи в Active Directory могут создавать службу ботов. Для этого администратору каталога необходимо настроить следующие параметры.

1. Войдите на [портал AAD](https://aad.portal.azure.com). В колонке **Пользователи и группы** выберите **Параметры пользователей**.
2. В разделе **Регистрация приложения** задайте параметру **Пользователи могут регистрировать приложения** значение **Да**. После этого пользователи в вашем каталоге смогут создавать службу ботов.
3. В разделе **Внешние пользователи** задайте параметру **Разрешения для гостей ограничены** значение **Нет**. После этого гостевые пользователи в вашем каталоге смогут создавать службу ботов.

![Центр администрирования Azure Active Directory](~/media/azure-active-directory/admin_center.png)

## <a name="why-cant-i-migrate-my-bot"></a>Почему не удается перенести бот?

Если бот зарегистрирован на dev.botframework.com и вы хотите перенести его в Azure, проблемы с миграцией бота могут возникать в том случае, если бот входит в каталог, отличный от каталога по умолчанию. Попробуйте выполнить следующие действия.

1. Из целевого каталога добавьте нового пользователя (с помощью адреса электронной почты), который не входит в каталог по умолчанию, назначьте пользователю роль участника для подписок, являющихся целью миграции.

2. На [портале разработчика](https://dev.botframework.com) добавьте адрес электронной почты пользователя в качестве совладельца бота, который следует перенести. Затем выполните выход.

3. Войдите на [портал разработчика](https://dev.botframework.com) в качестве нового пользователя и начните процесс миграции бота.

## <a name="where-can-i-get-more-help"></a>Где можно получить дополнительную помощь?

* Используйте сведения из ранее данных ответов на вопросы на сайте [Stack Overflow](https://stackoverflow.com/questions/tagged/botframework) или разместите свои вопросы с помощью тега `botframework`. Обратите внимание, что на Stack Overflow существуют правила для воспроизведения проблемы, например обязательное описательное название, полная и краткая формулировка проблемы и достаточное количество сведений. В данном документе не рассматриваются запросы функций или слишком общие вопросы. Для получения дополнительных сведений новым пользователям необходимо посетить [центр справки Stack Overflow](https://stackoverflow.com/help/how-to-ask).
* Чтобы найти информацию по известным проблемам с пакетом SDK Bot Framework или сообщить о новой проблеме, перейдите на соответствующую страницу для [BotBuilder](https://github.com/Microsoft/BotBuilder/issues) на сайте GitHub.
* Используйте сведения в обсуждениях сообщества BotBuilder на сайте [Gitter](https://gitter.im/Microsoft/BotBuilder).



[LUISPreBuiltEntities]: /azure/cognitive-services/luis/pre-builtentities
[BotFrameworkIDGuide]: bot-service-resources-identifiers-guide.md
[StateAPI]: ~/rest-api/bot-framework-rest-state.md
[TroubleshootingAuth]: bot-service-troubleshoot-authentication-problems.md

