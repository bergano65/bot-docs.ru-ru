---
title: Управление данными о состоянии | Документация Майкрософт
description: Узнайте, как сохранять и извлекать данные состояния с помощью службы "Состояние бота".
author: RobStand
ms.author: kamrani
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.subservice: sdk
ms.date: 12/13/2017
ms.openlocfilehash: b0d5ca6893d70a73bc005a949ef6cc2518d3862f
ms.sourcegitcommit: b78fe3d8dd604c4f7233740658a229e85b8535dd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/24/2018
ms.locfileid: "50000031"
---
# <a name="manage-state-data"></a>Управление данными состояния

Служба "Состояние бота" позволяет боту хранить и извлекать данные состояния, связанные с пользователем, диалогом или определенным пользователем в контексте определенного общения. Вы можете сохранить до 32 КБ данных для каждого пользователя и каждой беседы на канале, а также для каждого пользователя в контексте беседы в канале. Данные состояния можно использовать для многих целей, например для определения места остановки предыдущего диалога или просто для приветствия вернувшегося пользователя по имени. Если настройки пользователя сохраняются, можно использовать эту информацию для настройки диалога в следующий раз. Например, можно сообщить пользователю о новостной статье на интересующую его тему или оповестить его о том, что освободилось время для встречи. 

> [!IMPORTANT]
> API службы состояния Bot Framework не рекомендуется использовать для рабочей среды. Он может считаться устаревшим в будущем выпуске. Рекомендуется обновить код бота для использования хранилища в памяти в целях тестирования или использовать одно из **расширений Azure** для ботов в рабочей среде. Дополнительные сведения см. в разделе **Управление данными состояния** в документации по реализации [.NET](~/dotnet/bot-builder-dotnet-state.md) или [Node](~/nodejs/bot-builder-nodejs-state.md).

## <a id="concurrency"></a> Параллелизм данных

Чтобы управлять параллелизмом данных, которые хранятся с использованием службы "Состояние бота", платформа использует тег сущности (ETag) для запросов `POST`. Платформа не использует стандартные заголовки для ETags. Вместо этого текст запроса и ответа задает ETag при помощи свойства `eTag`. 

Например, если вы выполните запрос `GET` на извлечение пользовательских данных из хранилища, ответ будет содержать свойство `eTag`. Если вы изменили данные и выполняете запрос `POST` на сохранение обновленных данных в хранилище, ваш запрос может включать свойство `eTag`, содержащее то же значение, которое вы получили ранее в ответе `GET`. Если ETag, указанный в вашем запросе `POST`, соответствует текущему значению в хранилище, сервер сохранит данные пользователя и ответит **HTTP 200 Success** (HTTP 200 Успешно) и укажет новое значение `eTag` в теле ответа. Если ETag, указанный в вашем запросе `POST`, не соответствует текущему значению в хранилище, сервер ответит **HTTP 412 Precondition Failed**(HTTP 412 Условие ложно), чтобы указать, что данные пользователя в хранилище изменились с момента последнего сохранения или извлечения.

> [!TIP]
> Ответ `GET` всегда будет содержать свойство `eTag`, но вам не нужно указывать свойство `eTag` в запросах `GET`. Значение свойства `eTag` в виде звездочки (`*`) указывает, что ранее не были сохранены данные для указанной комбинации канала, пользователя и диалога.
>
> Указание свойства `eTag` в запросах `POST` является необязательным. 
> Если параллелизм не является проблемой для вашего бота, не включайте свойство `eTag` в запросы `POST`. 

## <a id="save-user-data"></a> Сохранение данных пользователя

Чтобы сохранить данные состояния для пользователя конкретного канала, выполните этот запрос:

```http
POST /v3/botstate/{channelId}/users/{userId}
```

В этом URI запроса замените **{channelId}** идентификатором канала и замените **{userId}** идентификатором пользователя на этом канале. Свойства `channelId` и `from` в любом сообщении, которое ваш бот ранее получил от пользователя, будут содержать эти идентификаторы. Вы также можете кэшировать эти значения в безопасном расположении, чтобы вы могли получить доступ к данным пользователя в будущем, не извлекая их из сообщения.

Задайте в качестве текста запроса объект [BotData][BotData], где свойство `data` указывает данные, которые вы хотите сохранить. Если вы используете теги сущностей для [контроля параллелизма](#concurrency), установите для свойства `eTag` значение ETag, которое вы получили в последнем ответе, когда сохраняли или извлекали данные пользователя (зависит от того, какое действие было последнем). Если вы не используете теги сущности для параллелизма, тогда не используйте свойство `eTag` в запросе.

> [!NOTE]
> Этот запрос `POST` будет перезаписывать пользовательские данные в хранилище, только если указанный ETag соответствует значению ETag сервера, или если в запросе не указан ETag.

### <a name="request"></a>Запрос 

В следующем примере показан запрос, который сохраняет данные для пользователя на конкретном канале. В этом примере запрос `https://smba.trafficmanager.net/apis` представляет базовый URI. Базовый URI для запросов, отправляемых вашим ботом, может отличаться. Дополнительные сведения о настройке базового URI см. в статье [Справочник по API](bot-framework-rest-connector-api-reference.md#base-uri).

```http
POST https://smba.trafficmanager.net/apis/v3/botstate/abcd1234/users/12345678
Authorization: Bearer ACCESS_TOKEN
Content-Type: application/json
```

```json
{
    "data": [
        {
            "trail": "Lake Serene",
            "miles": 8.2,
            "difficulty": "Difficult",
        },
        {
            "trail": "Rainbow Falls",
            "miles": 6.3,
            "difficulty": "Moderate",
        }
    ],
    "eTag": "a1b2c3d4"
}
```

### <a name="response"></a>Ответ 

Ответ будет содержать объект [BotData][BotData] с новым значением `eTag`.

## <a name="get-user-data"></a>Получение данных пользователя

Чтобы получить данные состояния, сохраненные для пользователя определенного канала, выполните этот запрос:

```http
GET /v3/botstate/{channelId}/users/{userId}
```

В этом URI запроса замените **{channelId}** идентификатором канала и замените **{userId}** идентификатором пользователя на этом канале. Свойства `channelId` и `from` в любом сообщении, которое ваш бот ранее получил от пользователя, будут содержать эти идентификаторы. Вы также можете кэшировать эти значения в безопасном расположении, чтобы вы могли получить доступ к данным пользователя в будущем, не извлекая их из сообщения.

### <a name="request"></a>Запрос

В следующем примере показан запрос, который получает данные, ранее сохраненные для пользователя. В этом примере запрос `https://smba.trafficmanager.net/apis` представляет базовый URI. Базовый URI для запросов, отправляемых вашим ботом, может отличаться. Дополнительные сведения о настройке базового URI см. в статье [Справочник по API](bot-framework-rest-connector-api-reference.md#base-uri).

```http
GET https://smba.trafficmanager.net/apis/v3/botstate/abcd1234/users/12345678
Authorization: Bearer ACCESS_TOKEN
Content-Type: application/json
```

### <a name="response"></a>Ответ

Ответ будет содержать объект [BotData][BotData], где свойство `data` содержит данные, ранее сохраненные для пользователя, а свойство `eTag` содержит значение ETag, которое вы можете использовать в рамках последующего запроса на сохранение данных пользователя. Если вы ранее не сохраняли данные для пользователя, свойство `data` будет равно `null`, а свойство `eTag` будет содержать звездочку (`*`).

В этом примере показан ответ для запроса `GET`:

```json
{
    "data": [
        {
            "trail": "Lake Serene",
            "miles": 8.2,
            "difficulty": "Difficult",
        },
        {
            "trail": "Rainbow Falls",
            "miles": 6.3,
            "difficulty": "Moderate",
        }
    ],
    "eTag": "xyz12345"
}
```

## <a name="save-conversation-data"></a>Сохранение данных диалога

Чтобы сохранить данные состояния для диалога конкретного канала, выполните этот запрос:

```http
POST /v3/botstate/{channelId}/conversations/{conversationId}
```

В этом URI запроса замените **{channelId}** идентификатором канала и замените **{conversationId}** идентификатором диалога. Свойства `channelId` и `conversation` в любом сообщении, которое ваш бот ранее отправлял или получал в контексте разговора, будут содержать эти идентификаторы. Вы также можете кэшировать эти значения в безопасном расположении, чтобы вы могли получить доступ к данным диалога в будущем, не извлекая их из сообщения.

Задайте в качестве текста запроса объект [BotData][BotData], как описано в разделе [Сохранение данных пользователя](#save-user-data).

> [!IMPORTANT]
> Так как операция [Удаление пользовательских данных](#delete-user-data) не удаляет данные, сохраненные с помощью операции **Сохранение данных диалога**, не нужно использовать эту операцию для хранения персональных данных пользователя (PII).

### <a name="response"></a>Ответ

Ответ будет содержать объект [BotData][BotData] с новым значением `eTag`.

## <a name="get-conversation-data"></a>Получение данные диалога

Чтобы получить данные состояния, сохраненные для диалога определенного канала, выполните этот запрос:

```http
GET /v3/botstate/{channelId}/conversations/{conversationId}
```

В этом URI запроса замените **{channelId}** идентификатором канала и замените **{conversationId}** идентификатором диалога. Свойства `channelId` и `conversation` в любом сообщении, которое ваш бот ранее отправлял или получал в контексте разговора, будут содержать эти идентификаторы. Вы также можете кэшировать эти значения в безопасном расположении, чтобы вы могли получить доступ к данным диалога в будущем, не извлекая их из сообщения.

### <a name="response"></a>Ответ

Ответ будет содержать объект [BotData][BotData] с новым значением `eTag`.

## <a name="save-private-conversation-data"></a>Сохранение личных данных диалога

Чтобы сохранить данные состояния для конкретного пользователя в контексте указанного диалога на канале, выполните этот запрос:

```http
POST /v3/botstate/{channelId}/conversations/{conversationId}/users/{userId}
```

В этом URI запроса замените **{channelId}** идентификатором канала, замените **{conversationId}** идентификатором диалога и замените **{userId}** идентификатором пользователя этого канала. Свойства `channelId`, `conversation` и `from` в любом сообщении, которое ваш бот ранее получал от пользователя в контексте разговора, будут содержать эти идентификаторы. Вы также можете кэшировать эти значения в безопасном расположении, чтобы вы могли получить доступ к данным диалога в будущем, не извлекая их из сообщения.

Задайте в качестве текста запроса объект [BotData][BotData], как описано в разделе [Сохранение данных пользователя](#save-user-data).

### <a name="response"></a>Ответ

Ответ будет содержать объект [BotData][BotData] с новым значением `eTag`.

## <a name="get-private-conversation-data"></a>Получение личных данных диалога

Чтобы получить данные состояния, сохраненные для пользователя в контексте конкретного общения, выполните этот запрос: 

```http
GET /v3/botstate/{channelId}/conversations/{conversationId}/users/{userId}
```

В этом URI запроса замените **{channelId}** идентификатором канала, замените **{conversationId}** идентификатором диалога и замените **{userId}** идентификатором пользователя этого канала. Свойства `channelId`, `conversation` и `from` в любом сообщении, которое ваш бот ранее получал от пользователя в контексте разговора, будут содержать эти идентификаторы. Вы также можете кэшировать эти значения в безопасном расположении, чтобы вы могли получить доступ к данным диалога в будущем, не извлекая их из сообщения.

### <a name="response"></a>Ответ

Ответ будет содержать объект [BotData][BotData] с новым значением `eTag`.

## <a name="delete-user-data"></a>Удаление пользовательских данных

Чтобы удалить данные состояния для пользователя конкретного канала, выполните этот запрос:

```http
DELETE /v3/botstate/{channelId}/users/{userId}
```
В этом URI запроса замените **{channelId}** идентификатором канала и замените **{userId}** идентификатором пользователя на этом канале. Свойства `channelId` и `from` в любом сообщении, которое ваш бот ранее получил от пользователя, будут содержать эти идентификаторы. Вы также можете кэшировать эти значения в безопасном расположении, чтобы вы могли получить доступ к данным пользователя в будущем, не извлекая их из сообщения.

> [!IMPORTANT]
> Эта операция удаляет данные состояния, сохраненные ранее для пользователя с использованием операции [Сохранение данных пользователя](#save-user-data) или [Сохранение личных данных диалога](#save-private-conversation-data). Она не удаляет ранее сохраненные данные с использованием операции [Сохранение данных диалога](#save-conversation-data). Поэтому вы не должны использовать операцию **Сохранение данных диалога** для хранения персональных данных пользователя (PII).

Ваш бот должен выполнить операцию **Удаление пользовательских данных**, когда он получает [операцию][Activity] типа [deleteUserData](bot-framework-rest-connector-activities.md#deleteuserdata) или [contactRelationUpdate](bot-framework-rest-connector-activities.md#contactrelationupdate), которые указывают, что бот удален из списка контактов пользователя.

## <a name="additional-resources"></a>Дополнительные ресурсы

- [Основные понятия](bot-framework-rest-connector-concepts.md)
- [Общие сведения о действиях](bot-framework-rest-connector-activities.md)

[BotData]: bot-framework-rest-connector-api-reference.md#botdata-object
[Activity]: bot-framework-rest-connector-api-reference.md#activity-object
