---
title: ПО промежуточного слоя | Документация Майкрософт
description: Общие сведения о ПО промежуточного слоя и его использовании в пакете SDK бота.
keywords: ПО промежуточного слоя, конвейер ПО промежуточного слоя, короткий канал, использование ПО промежуточного слоя
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 05/24/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 20f5387e7c1ea40e6b9848a1071e542dcd1cacaa
ms.sourcegitcommit: aef7d80ceb9c3ec1cfb40131709a714c42960965
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/17/2018
ms.locfileid: "49383169"
---
# <a name="middleware"></a>ПО промежуточного слоя

[!INCLUDE [pre-release-label](../includes/pre-release-label.md)]

ПО промежуточного слоя — это просто класс, который находится между адаптером и логикой бота, добавленный в коллекцию промежуточного программного обеспечения адаптера во время инициализации. Пакет SDK позволяет писать собственное ПО промежуточного слоя или добавить повторно используемые его компоненты, созданные другими пользователями. Любые входящие или исходящие действия вашего бота будут передаваться через ПО промежуточного слоя.

Адаптер обрабатывает и направляет входящие действия через конвейер ПО промежуточного слоя бота в логику бота, а затем обратно. Каждая последовательность действий входа и выхода бота, каждый компонент ПО промежуточного слоя может проверять или выполнять действие до и после запуска логики бота.

Прежде чем приступить к работе с ПО промежуточного слоя, важно понять суть [ботов в целом](~/v4sdk/bot-builder-basics.md) и [как они обрабатывают действия](~/v4sdk/bot-builder-basics.md#the-activity-processing-stack).

## <a name="uses-for-middleware"></a>Использование ПО промежуточного слоя
Часто возникает вопрос, в каких случаях нужно реализовать действия в ПО промежуточного слоя вместо использования обычной логики бота. ПО промежуточного слоя расширяет интерактивные возможности ведения диалога с пользователями как перед, так и после обработки каждой _реплики_. Кроме того, ПО промежуточного слоя позволяет сохранять и извлекать сведения, касающиеся диалога, а также при необходимости вызывать дополнительную логику обработки. Ниже описаны некоторые распространенные сценарии применения ПО промежуточного слоя.

### <a name="looking-at-or-acting-on-every-activity"></a>Просмотр каждого действия и его выполнение
Есть множество ситуаций, которые требуют от бота соответствующего поведения для всех действий или только для отдельных действий определенного типа. Например, нам необходимо зарегистрировать каждое действие сообщения, которое получает бот, или предоставить резервный ответ, если бот еще не создал реплику ответа. ПО промежуточного слоя — это отличное место для этого со способностью действовать как до, так и после выполнения остальной части логики бота.

### <a name="modifying-or-enhancing-the-turn-context"></a>Изменение или расширение контекста включения
Некоторые общения могут быть намного плодотворнее, если бот имеет больше информации, чем предусмотрено в этом действии. ПО промежуточного слоя в этом случае может просмотреть текущие сведения о состоянии беседы, запросить источник внешних данных и добавить это к объекту [контекста реплик](~/v4sdk/bot-builder-basics.md#defining-a-turn) перед передачей выполнения логике бота. 

В пакете SDK определено ПО промежуточного слоя для ведения журнала, позволяющее записывать входящие и исходящие действия. Но вы можете определить собственное ПО промежуточного слоя.

## <a name="the-bot-middleware-pipeline"></a>Конвейер ПО промежуточного слоя бота
Адаптер вызывает ПО промежуточного слоя для каждого действия в том порядке, в котором оно было добавлено. Адаптер передает объект контекста для возвращения и _следующего_ делегата, а ПО промежуточного слоя вызывает делегат для передачи управления следующему промежуточному программному обеспечению в конвейере. ПО промежуточного слоя также имеет возможность выполнять действия после возвращения _следующего_ делегата до завершения метода. Можно представить, что каждый объект ПО промежуточного слоя имеет первую и последнюю возможность действовать в отношении объектов ПО промежуточного слоя, которые следуют за ним в конвейере.

Например: 

- Обработчик 1-го объекта ПО промежуточного слоя выполняет код перед вызовом _следующего_.
  - Обработчик 2-го объекта ПО промежуточного слоя выполняет код перед вызовом _следующего_.
    - Обработчик бота выполняет и возвращает.
  - Обработчик 2-го объекта ПО промежуточного слоя выполняет любой оставшийся код перед возвращением.
- Обработчик 1-го объекта ПО промежуточного слоя выполняет любой оставшийся код перед возвращением.

Если ПО промежуточного слоя не вызывает следующий делегат, адаптер не вызывает ни одно из последующих ПО или обработчиков бота, а также сокращается конвейер.

После завершения работы конвейера ПО промежуточного слоя бота возвращение завершается и его контекст выходит за пределы области.

ПО промежуточного слоя или бот могут создавать ответы и регистрировать обработчики событий ответа, но учитывайте, что ответы обрабатываются в отдельных процессах.

## <a name="order-of-middleware"></a>Порядок выполнения ПО промежуточного слоя
Поскольку порядок добавления ПО промежуточного слоя определяет порядок, в котором оно обрабатывает действие, важно определить последовательность добавления ПО промежуточного слоя.

> [!NOTE]
> Это дает общий шаблон, который работает для большинства ботов, но имейте ввиду, что каждая часть ПО промежуточного слоя будет взаимодействовать с другими частями.

Первыми действиями в конвейере ПО промежуточного слоя должны быть те, которые берут на себя задачи самого низкого уровня, которые используются постоянно. Например, ведение журнала, обработка исключений и перевод. Их порядок зависит от потребностей. Скажем, вам нужно перевести входящее сообщение перед сохранением или же сообщение требуется сохранить до перевода (что может означать, что сохраненные сообщения не будут переведены).

Последним в конвейере ПО промежуточного слоя должен быть специальный бот ПО промежуточного слоя, который является программным обеспечением, реализующим выполнение обработки каждого сообщения, отправленного вашему боту. Если ПО промежуточного слоя использует информацию о состоянии или другую информацию, заданную в контексте бота, добавьте ее в конвейер программного обеспечения после того, как оно изменит состояние или контекст.

## <a name="short-circuiting"></a>Сокращение каналов
_Сокращение каналов_ — важный фактор работы ПО промежуточного слоя (и [обработчиков ответов](bot-builder-basics.md#response-event-handlers)). Если выполнение должно продолжаться через последующие слои, нужно, чтобы ПО промежуточного слоя (или обработчик ответов) передало данные выполнения, вызвав _следующий_ делегат.  Если следующий делегат не вызывается в рамках ПО промежуточного слоя (или обработчика ответов), соответствующий конвейер сокращает канал и последующие слои не выполняются. Это означает, что вся логика ботов и любое ПО промежуточного слоя, определенное далее в конвейере, пропускается. Есть небольшое различие между способами сокращения каналов для реплик в ПО промежуточного слоя и в обработчике ответов.

Когда промежуточное ПО сокращает канал реплики, обработчик реплик бота не вызывается, а весь код ПО промежуточного слоя, выполненный до этого момента в конвейере, продолжает выполняться до завершения. 

Пропуск вызова _следующего_ делегата в обработчике событий означает, что событие отменяется и значительно отличается от логики пропуска промежуточного программного обеспечения. Не обработав остальную часть события, адаптер никогда не отправит его.

> [!TIP]
> Если вы сокращаете канал события ответа, например `SendActivities`, убедитесь, что такое поведение действительно требуется. Иначе возникнут трудности с исправлением этой ошибки.

## <a name="additional-resources"></a>Дополнительные ресурсы
Ознакомьтесь со сведениями о ПО промежуточного слоя для ведения журнала расшифровки, реализованное в пакете SDK Bot Builder [[C#](https://github.com/Microsoft/botbuilder-dotnet/blob/master/libraries/Microsoft.Bot.Builder/TranscriptLoggerMiddleware.cs)|[JS](https://github.com/Microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/transcriptLogger.ts)].
