---
title: Общения в пакете SDK для Bot Builder | Документация Майкрософт
description: Описание общения в пакете SDK для Bot Builder.
keywords: последовательность общения, распознавание намерения, одно включение, много включений
author: jonathanfingold
ms.author: jonathanfingold
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 04/11/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 32486cb024dfe852a7478ccba4a0eedc476431b0
ms.sourcegitcommit: ee63d9dc1944a6843368bdabf5878950229f61d0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/23/2018
ms.locfileid: "42795033"
---
# <a name="conversation-flow"></a>Последовательность общения
[!INCLUDE [pre-release-label](../includes/pre-release-label.md)]

Бот — это пользовательский интерфейс для общения, а последовательность общения — это взаимодействие с пользователем и возможность принимать разные формы. Наличие правильной последовательности общения помогает улучшить взаимодействие пользователя и производительность бота.

Проектирование последовательности общения бота включает решение, как бот отвечает, когда пользователь что-то ему говорит. Бот сначала распознает тему задачи или общения на основе сообщения от пользователя. Чтобы определить задачу или тему (известную как *намерение*), связанную с сообщением пользователя, бот может искать слова или шаблоны в тексте сообщения пользователя или может воспользоваться такими услугами, как [Интеллектуальная служба распознавания речи](bot-builder-concept-luis.md) и QnA Maker. 

Как только бот распознает намерение пользователя, в зависимости от сценария он может выполнить запрос пользователя с помощью одного ответа, завершить общение за одно включение или потребовать серию включений. Для множественных включений последовательности общения пакет SDK Bot Builder предоставляет [управление состоянием](./bot-builder-howto-v4-state.md) для отслеживания общения, [приглашения](bot-builder-prompts.md) для запроса информации и [диалоги](bot-builder-dialog-manage-conversation-flow.md) для формирования последовательности общения. 

В сложном боте с несколькими подсистемами может использоваться несколько сервисов для распознавания намерения, по одному для каждого подкомпонента бота. Объединение подсистем общения в один бот позволяет [Средству подготовки к отправке](bot-builder-tutorial-dispatch.md) получать результаты нескольких сервисов в одном месте. 
<!-- 
A conversation identifies a series of activities sent between a bot and a user on a specific channel and represents an interaction between one or more bots and either a _direct_ conversation with a specific user or a _group_ conversation with multiple users.
A bot communicates with a user on a channel by receiving activities from, and sending activities to the user.

- Each user has an ID that is unique per channel.
- Each conversation has an ID that is unique per channel.
- The channel sets the conversation ID when it starts the conversation.
- The bot cannot start a conversation; however, once it has a conversation ID, it can resume that conversation.
- Not all channels support group conversations.
-->

## <a name="single-turn-conversation"></a>Общение с одним включением

Общение с одним включением — это самый простой вид последовательности общения. В этом виде потока бот заканчивает свою задачу за один ход, состоящий из одного сообщения от пользователя и одного ответа от бота. 



<!-- 
The EchoBot sample in the BotBuilder SDK is a single-turn bot. Here are other examples of single turn conversation flow:
* A bot for getting the weather report, that just tells the user what the weather is, when they say "What's the weather?".
* An IoT bot that responds to "turn on the lights" by calling an IoT service. -->

<!-- The following isn't always true, it's a generalization --> Простейший вид бота с одним включением, который не нуждается в отслеживании состояния общения. Каждый раз при получении сообщения, ответ выполняется на основе контекста текущего входящего сообщения без знания прошлых включений общения.

![Бот погоды с одним включением](./media/concept-conversation/weather-single-turn.png)

Бот погоды имеет одно включение, он дает пользователю отчет о погоде, не возвращаясь назад или забегая вперед, запрашивая город или дату. Вся логика для отображения погоды основана на недавно полученном сообщении. На каждом этапе общения бот получает [контекст реплик](bot-builder-concept-activity-processing.md#turn-context), который он может использовать, чтобы определить, что делать дальше и каким будет процесс общения. 

## <a name="multiple-turns"></a>Общение с множеством включений

Большинство типов общения невозможно выполнить за одно включение, поэтому бот может иметь несколько включений последовательности общения. Некоторые сценарии, требующие нескольких включений общения, вмещают следующее.

 * Бот, который запрашивает у пользователя дополнительную информацию, необходимую для выполнения задачи. Бот должен отслеживать, имеет ли он все параметры для выполнения задачи.
 * Бот, который проводит пользователя через шаги процесса, например размещение заказа. Бот должен отслеживать, где пользователь находится в последовательности шагов.

Например, у бота погоды есть последовательность множества включений, если бот отвечает на вопрос "Какая погода?" запрашивая город.

![разговор о погоде со множеством включений](./media/concept-conversation/weather-multi-turn.png)

Когда пользователь отвечает на вопрос бота о городе и называет: "Сиэтл", бот должен иметь некоторый контекст, чтобы понять, что текущее сообщение является ответом на предыдущий вопрос и частью запроса о погоде. Боты со множеством включений отслеживают состояние для надлежащего реагирования на новые сообщения.

<!--
```
// TBD: snippet showing receiving message and using ConversationProperties
```
-->

Дополнительные сведения см. в разделах [Сохранение состояния и доступа к данным](bot-builder-storage-concept.md) и [Save state using conversation and user properties](bot-builder-howto-v4-state.md) (Сохранение состояния с помощью свойств общения и пользователя).

> [!NOTE]
> Общение со множеством включений с клиентами REST API должны отслеживать их состояние, например в хранилище базы данных или таблицы. 

## <a name="conversation-topics"></a>Темы общения

Можно разработать бот для обработки более чем одного типа задачи. Например, имеется бот, который предоставляет разные последовательности общения: для приветствия пользователя, размещения заказа, отмены и получения помощи. Один из способов управления этим переключением между общением для разных задач или тем общения — это распознать намерение (то, что пользователь хочет сделать) из текущего сообщения. 

### <a name="recognize-intent"></a>Распознавание намерения

Пакет SDK для Bot Builder предоставляет _программы-распознаватели_, которые обрабатывают каждое входящее сообщение для определения намерения, поэтому бот может инициировать соответствующую последовательность общения. Прежде чем _получить ответный вызов_, программы-распознаватели просматривают содержимое сообщения от пользователя для определения намерения. Затем они возвращают намерение боту, используя объект контекста реплик, сохраняемый как **Главное намерение** в объекте [контекста реплик](bot-builder-concept-activity-processing.md#turn-context). 

Распознаватель, который определяет **Главное намерение**, может использовать регулярные выражения, службу Распознавания речи (LUIS) или другие инструменты межплатформенного программного обеспечения. Примерами программ-распознавателей могут быть следующие.
   
* Настройте распознаватель с помощью регулярных выражений, чтобы он мог понимать, когда пользователю нужна помощь.
* Интеллектуальная служба распознавания речи (LUIS) используется, чтобы обучить службы с помощью примеров того, как пользователь может обратиться за помощью, и сопоставить его с намерением Help.
* Создайте свое собственное промежуточное программное обеспечение распознавателя, которое проверяет входящие действия и применяет намерение translate каждый раз, когда обнаруживает сообщение на другом языке.

Дополнительные сведения см. в разделе [Language Understanding for bots](bot-builder-concept-luis.md) (Распознавание речи для ботов). <!-- TODO: ADD THIS TOPIC OR SNIPPET-->

### <a name="consider-how-to-interrupt-conversation-flow-or-change-topics"></a>Прерывание последовательности общения или изменение темы

Один из способов следить, где вы находитесь в общении, — использование [состояния общения](bot-builder-howto-v4-state.md) для сохранения сведений о текущей активной теме или о том, какие шаги в последовательности были завершены.

Когда бот становится более сложным, можно просмотреть распределение последовательности потоков общения. Например, бот вызывает новую последовательность заказа, а затем вызовет последовательность поиска продукта. Затем пользователь выберет продукт и подтвердит завершение поиска продукта и завершит заказ.

Однако общение редко идет таким линейным, логическим путем. Пользователи не взаимодействуют в "стеках", они часто их меняют. Рассмотрим следующий пример.

![Пользователь говорит что-то непредвиденное.](./media/concept-conversation/interruption.png)

Хотя бот может логически строить стек последовательностей, пользователь может решить сделать что-то совершенно другое или задать вопрос, который может быть не связан с текущей темой. В примере пользователь спрашивает, а не предоставляет ответ "yes" или "no", который ожидает последовательность. Как должна реагировать последовательность?

* Пользователю сначала нужно ответить на вопрос.
* Не обращайте внимания на все, что сделал пользователь ранее, сбросьте весь стек последовательности и начните с самого начала, пытаясь ответить на вопрос пользователя.
* Попытайтесь ответить на вопрос пользователя, а затем вернуться к вопросу с ответом "Да" или"Нет" и продолжить работу с того момента.

Нет единого правильного ответа на этот вопрос, лучшее решение будет зависеть от особенностей сценария и ожидания пользователя на ответ от бота. Дополнительные сведения см. в разделе [Handle user interrupt](bot-builder-howto-handle-user-interrupt.md) (Обработка прерываний пользователя).

> [!TIP]
> При использовании пакета SDK Bot Builder для Node.js с помощью [диалогов](bot-builder-dialog-manage-conversation-flow.md) можно управлять последовательностью общения.

## <a name="conversation-lifetime"></a>Время существования общения

<!-- Note: these activities are dependent on whether the channel actually sends them. Also, we should add links --> Бот получает активность _обновления общения_ всякий раз, когда его добавляют в общение, добавляются или удаляются из общения другие участники или меняются метаданные общения.
Бот может реагировать на действия обновления общения, приветствуя пользователя или представляя самого себя.

Бот получает действие _конец общения_, чтобы указать, что пользователь закончил общение. Бот может отправить действие _конца общения_, чтобы сказать пользователю, что общение окончено. По завершении общения информацию о нем можно удалить.

<!--  Types of conversations

Your bot can support multi-turn interactions where it prompts users for multiple peices of information. It can be focused on a very specific task or support multiple types of tasks. 
The Bot Builder SDK has some built-in support for Language Understatnding (LUIS) and QnA Maker for adding natural language "question and answer" features to your bot.

<!--TODO: Add with links when these topics are available:
[Conversation flow] and other design articles.
[Using recognizers] [Using state and storage] and other how tos.
-->
## <a name="conversations-channels-and-users"></a>Общения, каналы и пользователи

Общения могут быть либо _прямыми_ — с конкретным пользователем или _групповыми_ — с несколькими пользователями.
Бот взаимодействует с пользователем по каналу, получая и отправляя действия пользователю.

- Каждый пользователь имеет идентификатор, который является уникальным для канала.
- У каждого общения есть идентификатор, который является уникальным для канала.
- Канал задает идентификатор общения, когда начинает общение.
- Бот не может начать общение. Тем не менее если он имеет идентификатор общения, то можно возобновить это общение.
- Не все каналы поддерживают групповые беседы.

## <a name="next-steps"></a>Дополнительная информация

Для сложных общений, таких как представленные выше, должна быть возможность сохранять данные дольше, чем на одно включение. Рассмотрим состояние и хранилище.

> [!div class="nextstepaction"]
> [Сохранение состояния и доступа к данным](bot-builder-storage-concept.md) 

<!-- In addition, your bot can send activities back to the user, either _proactively_, in response to internal logic, or _reactively_, in response to an activity from the user or channel.-->
<!--TODO: Link to messaging how tos.-->

<!--  TODO: Change to next steps, one for each of LUIS and State
## See also

- Activities
- Adapter
- Context
- Proactive messaging
- State
-->

[QnAMaker]:(bot-builder-luis-and-qna.md#using-qna-maker)

<!-- TODO: Update when the Dispatch concept is pushed -->
[Dispatch]:(bot-builder-concept-luis.md)
